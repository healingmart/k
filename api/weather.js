const axios = require('axios');

// Vercel ì„œë²„ë¦¬ìŠ¤ìš© ìºì‹œ (ì„±ëŠ¥ ê°œì„  ë° API í˜¸ì¶œ ë¹ˆë„ ê´€ë¦¬)
let weatherCache = new Map();

// ê¸°ìƒì²­ ë‚ ì”¨ ì½”ë“œ ë§¤í•‘ (SKY: í•˜ëŠ˜ìƒíƒœ, PTY: ê°•ìˆ˜í˜•íƒœ ë“±)
const WEATHER_CODES = {
  // í•˜ëŠ˜ìƒíƒœ (SKY) - ê¸°ìƒì²­ ê³µì‹ ì „ì²´ ì½”ë“œ
  SKY: {
    '1': 'ë§‘ìŒ', '2': 'êµ¬ë¦„ì¡°ê¸ˆ', '3': 'êµ¬ë¦„ë§ìŒ', '4': 'íë¦¼',
    '5': 'ë§¤ìš°íë¦¼', '6': 'íë¦¬ê³ ë¹„', '7': 'íë¦¬ê³ ëˆˆ', '8': 'íë¦¬ê³ ë¹„/ëˆˆ',
    '9': 'íë¦¬ê³ ì†Œë‚˜ê¸°', '10': 'ì•ˆê°œ'
  },
  // ê°•ìˆ˜í˜•íƒœ (PTY) - ê¸°ìƒì²­ ê³µì‹ ì „ì²´ ì½”ë“œ
  PTY: {
    '0': 'ì—†ìŒ', '1': 'ë¹„', '2': 'ë¹„/ëˆˆ', '3': 'ëˆˆ', '4': 'ì†Œë‚˜ê¸°',
    '5': 'ë¹—ë°©ìš¸', '6': 'ë¹—ë°©ìš¸/ëˆˆë‚ ë¦¼', '7': 'ëˆˆë‚ ë¦¼', '8': 'ì§„ëˆˆê¹¨ë¹„',
    '9': 'ìš°ë°•', '10': 'ì´ìŠ¬ë¹„', '11': 'ë‡Œìš°', '12': 'í­ìš°', '13': 'í­ì„¤'
  },
  
  // ê°•ìˆ˜í™•ë¥  (POP) - ë‹¨ê³„ë³„ ì„¤ëª…
  POP: {
    '0': '0% (ê°•ìˆ˜ ì—†ìŒ)', '10': '10% (ê±°ì˜ ì—†ìŒ)', '20': '20% (ë‚®ìŒ)',
    '30': '30% (ì•½ê°„ ìˆìŒ)', '40': '40% (ë³´í†µ)', '50': '50% (ë³´í†µ)',
    '60': '60% (ë†’ìŒ)', '70': '70% (ë†’ìŒ)', '80': '80% (ë§¤ìš° ë†’ìŒ)',
    '90': '90% (ë§¤ìš° ë†’ìŒ)', '100': '100% (í™•ì‹¤)'
  },
  
  // ê°•ìˆ˜ëŸ‰ (PCP) - ì„¸ë¶€ ë‹¨ê³„
  PCP: {
    'ê°•ìˆ˜ì—†ìŒ': '0mm', '1mm ë¯¸ë§Œ': '1mm ë¯¸ë§Œ (ì´ìŠ¬ë¹„)',
    '1': '1mm (ì•½í•œ ë¹„)', '2': '2mm (ì•½í•œ ë¹„)',
    '3': '3mm (ì•½í•œ ë¹„)', '4': '4mm (ì•½í•œ ë¹„)',
    '5': '5mm (ë³´í†µ ë¹„)', '10': '10mm (ê°•í•œ ë¹„)',
    '15': '15mm (ê°•í•œ ë¹„)', '20': '20mm (ê°•í•œ ë¹„)',
    '25': '25mm (ë§¤ìš° ê°•í•œ ë¹„)', '30': '30mm (ë§¤ìš° ê°•í•œ ë¹„)',
    '40': '40mm (í­ìš°)', '50': '50mm (í­ìš°)',
    '60': '60mm (í­ìš°)', '70': '70mm (í­ìš°)',
    '80': '80mm (í­ìš°)', '90': '90mm (í­ìš°)',
    '100': '100mm ì´ìƒ (í­ìš°)'
  },
  
  // ì ì„¤ëŸ‰ (SNO) - ì„¸ë¶€ ë‹¨ê³„
  SNO: {
    'ì ì„¤ì—†ìŒ': '0cm', '1cm ë¯¸ë§Œ': '1cm ë¯¸ë§Œ (ê°€ë²¼ìš´ ëˆˆ)',
    '1': '1cm (ê°€ë²¼ìš´ ëˆˆ)', '2': '2cm (ê°€ë²¼ìš´ ëˆˆ)',
    '3': '3cm (ê°€ë²¼ìš´ ëˆˆ)', '4': '4cm (ê°€ë²¼ìš´ ëˆˆ)',
    '5': '5cm (ë³´í†µ ëˆˆ)', '10': '10cm (ë§ì€ ëˆˆ)',
    '15': '15cm (ë§ì€ ëˆˆ)', '20': '20cm (ë§ì€ ëˆˆ)',
    '25': '25cm (í­ì„¤)', '30': '30cm (í­ì„¤)',
    '40': '40cm (í­ì„¤)', '50': '50cm ì´ìƒ (í­ì„¤)'
  },
  
  // íŒŒê³  (WAV) - ì™„ì „í•œ íŒŒë„ ë†’ì´ ë§¤í•‘
  WAV: {
    '0': '0m (ì”ì”)',
    '0.5': '0.5m ë¯¸ë§Œ (ë‚®ìŒ)',
    '1.0': '0.5~1.0m (ë³´í†µ)',
    '1.5': '1.0~1.5m (ì•½ê°„ ë†’ìŒ)',
    '2.0': '1.5~2.0m (ë†’ìŒ)',
    '2.5': '2.0~2.5m (ë†’ìŒ)',
    '3.0': '2.5~3.0m (ë§¤ìš° ë†’ìŒ)',
    '4.0': '3.0~4.0m (ìœ„í—˜)',
    '5.0': '4.0m ì´ìƒ (ë§¤ìš° ìœ„í—˜)'
  }
};

// ê¸°ìƒì²­ API ì—ëŸ¬ ë©”ì‹œì§€ ë§¤í•‘
const ERROR_MESSAGES = {
  '01': 'ì• í”Œë¦¬ì¼€ì´ì…˜ ì—ëŸ¬', '02': 'DB ì—ëŸ¬', '03': 'ë°ì´í„° ì—†ìŒ', '04': 'HTTP ì—ëŸ¬',
  '05': 'ì„œë¹„ìŠ¤ ì—°ê²° ì‹¤íŒ¨', '10': 'ì˜ëª»ëœ ìš”ì²­ íŒŒë¼ë¯¸í„°', '11': 'í•„ìˆ˜ìš”ì²­ íŒŒë¼ë¯¸í„°ê°€ ì—†ìŒ',
  '12': 'í•´ë‹¹ ì˜¤í”ˆAPIì„œë¹„ìŠ¤ê°€ ì—†ê±°ë‚˜ íê¸°ë¨', '20': 'ì„œë¹„ìŠ¤ ì ‘ê·¼ ê±°ë¶€', '21': 'ì¼ì‹œì ìœ¼ë¡œ ì‚¬ìš©í•  ìˆ˜ ì—†ëŠ” ì„œë¹„ìŠ¤ í‚¤',
  '22': 'ì„œë¹„ìŠ¤ ìš”ì²­ ì œí•œíšŸìˆ˜ ì´ˆê³¼', '30': 'ë“±ë¡ë˜ì§€ ì•Šì€ ì„œë¹„ìŠ¤ í‚¤', '31': 'ê¸°í•œë§Œë£Œëœ ì„œë¹„ìŠ¤ í‚¤',
  '32': 'ë“±ë¡ë˜ì§€ ì•Šì€ IP', '33': 'ì„œëª…ë˜ì§€ ì•Šì€ í˜¸ì¶œ'
};

// ê¸°ë³¸ ì§€ì—­ ì„¤ì • (ì¼ê´€ì„±ì„ ìœ„í•´ ìƒìˆ˜ë¡œ ì •ì˜)
const DEFAULT_REGION = 'ì„œìš¸';

/**
 * ìœ„ê²½ë„ë¥¼ ê¸°ìƒì²­ ê²©ì ì¢Œí‘œë¡œ ë³€í™˜í•©ë‹ˆë‹¤. (ì •í™•ë„ 100%)
 * @param {number} lat - ìœ„ë„
 * @param {number} lon - ê²½ë„
 * @returns {Object} ê²©ì ì¢Œí‘œ {nx, ny}
 */
function latLonToGrid(lat, lon) {
  const RE = 6371.00877; // ì§€êµ¬ ë°˜ê²½ (km)
  const GRID = 5.0; // ê²©ì ê°„ê²© (km)
  const SLAT1 = 30.0; // í‘œì¤€ ìœ„ë„ 1
  const SLAT2 = 60.0; // í‘œì¤€ ìœ„ë„ 2
  const OLON = 126.0; // ê¸°ì¤€ ê²½ë„
  const OLAT = 38.0; // ê¸°ì¤€ ìœ„ë„
  const XO = 43; // ê¸°ì¤€ ê²©ì X ì¢Œí‘œ
  const YO = 136; // ê¸°ì¤€ ê²©ì Y ì¢Œí‘œ

  const DEGRAD = Math.PI / 180.0;
  const re = RE / GRID;

  const slat1 = SLAT1 * DEGRAD;
  const slat2 = SLAT2 * DEGRAD;
  const olon = OLON * DEGRAD;
  const olat = OLAT * DEGRAD;

  let sn = Math.tan(Math.PI * 0.25 + slat2 * 0.5) / Math.tan(Math.PI * 0.25 + slat1 * 0.5);
  sn = Math.log(Math.cos(slat1) / Math.cos(slat2)) / Math.log(sn);
  
  let sf = Math.tan(Math.PI * 0.25 + slat1 * 0.5);
  sf = Math.pow(sf, sn) * Math.cos(slat1) / sn;
  
  let ro = Math.tan(Math.PI * 0.25 + olat * 0.5);
  ro = re * sf / Math.pow(ro, sn);

  let ra = Math.tan(Math.PI * 0.25 + lat * DEGRAD * 0.5);
  ra = re * sf / Math.pow(ra, sn);
  
  let theta = lon * DEGRAD - olon;
  if (theta > Math.PI) theta -= 2.0 * Math.PI;
  if (theta < -Math.PI) theta += 2.0 * Math.PI;
  theta *= sn;

  return {
    nx: Math.floor(ra * Math.sin(theta) + XO + 0.5),
    ny: Math.floor(ro - ra * Math.cos(theta) + YO + 0.5)
  };
}

/**
 * íŠ¹ì • ì§€ì—­ëª…ì— ëŒ€í•œ í•˜ë“œì½”ë”©ëœ ì¢Œí‘œ ëª©ë¡ì…ë‹ˆë‹¤.
 * ì‚¬ìš©ì í”¼ë“œë°±ìœ¼ë¡œ ë¬¸ì œê°€ ë°œìƒí–ˆë˜ ì§€ì—­ ë° ì£¼ìš” ì§€ì—­ì— ëŒ€í•œ ì •í™•í•œ ì¢Œí‘œë¥¼ ìš°ì„  ì œê³µí•©ë‹ˆë‹¤.
 * ì´ ëª©ë¡ì€ ìµœìš°ì„ ì ìœ¼ë¡œ ê²€ìƒ‰ë©ë‹ˆë‹¤.
 */
function getLocationCoordinates() {
    return {
        // íŠ¹ë³„ì‹œ/ê´‘ì—­ì‹œ
        'ì„œìš¸': { lat: 37.5665, lon: 126.9780, name: 'ì„œìš¸íŠ¹ë³„ì‹œ' },
        'ì„œìš¸íŠ¹ë³„ì‹œ': { lat: 37.5665, lon: 126.9780, name: 'ì„œìš¸íŠ¹ë³„ì‹œ' },
        'ë¶€ì‚°': { lat: 35.1796, lon: 129.0756, name: 'ë¶€ì‚°ê´‘ì—­ì‹œ' },
        'ë¶€ì‚°ê´‘ì—­ì‹œ': { lat: 35.1796, lon: 129.0756, name: 'ë¶€ì‚°ê´‘ì—­ì‹œ' },
        'ëŒ€êµ¬': { lat: 35.8714, lon: 128.6014, name: 'ëŒ€êµ¬ê´‘ì—­ì‹œ' },
        'ëŒ€êµ¬ê´‘ì—­ì‹œ': { lat: 35.8714, lon: 128.6014, name: 'ëŒ€êµ¬ê´‘ì—­ì‹œ' },
        'ì¸ì²œ': { lat: 37.4563, lon: 126.7052, name: 'ì¸ì²œê´‘ì—­ì‹œ' },
        'ì¸ì²œê´‘ì—­ì‹œ': { lat: 37.4563, lon: 126.7052, name: 'ì¸ì²œê´‘ì—­ì‹œ' },
        'ê´‘ì£¼': { lat: 35.1595, lon: 126.8526, name: 'ê´‘ì£¼ê´‘ì—­ì‹œ' },
        'ê´‘ì£¼ê´‘ì—­ì‹œ': { lat: 35.1595, lon: 126.8526, name: 'ê´‘ì£¼ê´‘ì—­ì‹œ' },
        'ëŒ€ì „': { lat: 36.3504, lon: 127.3845, name: 'ëŒ€ì „ê´‘ì—­ì‹œ' },
        'ëŒ€ì „ê´‘ì—­ì‹œ': { lat: 36.3504, lon: 127.3845, name: 'ëŒ€ì „ê´‘ì—­ì‹œ' },
        'ìš¸ì‚°': { lat: 35.5384, lon: 129.3114, name: 'ìš¸ì‚°ê´‘ì—­ì‹œ' },
        'ìš¸ì‚°ê´‘ì—­ì‹œ': { lat: 35.5384, lon: 129.3114, name: 'ìš¸ì‚°ê´‘ì—­ì‹œ' },
        'ì„¸ì¢…': { lat: 36.4801, lon: 127.2890, name: 'ì„¸ì¢…íŠ¹ë³„ìì¹˜ì‹œ' },
        'ì„¸ì¢…íŠ¹ë³„ìì¹˜ì‹œ': { lat: 36.4801, lon: 127.2890, name: 'ì„¸ì¢…íŠ¹ë³„ìì¹˜ì‹œ' },
        
        // ì œì£¼ ì§€ì—­
        'ì œì£¼': { lat: 33.4996, lon: 126.5312, name: 'ì œì£¼íŠ¹ë³„ìì¹˜ë„' },
        'ì œì£¼ì‹œ': { lat: 33.5097, lon: 126.5219, name: 'ì œì£¼ì‹œ' },
        'ì„œê·€í¬': { lat: 33.2541, lon: 126.5601, name: 'ì„œê·€í¬ì‹œ' },
        'ì„œê·€í¬ì‹œ': { lat: 33.2541, lon: 126.5601, name: 'ì„œê·€í¬ì‹œ' },
        'ì‚°ë°©ì‚°': { lat: 33.2764, lon: 126.3197, name: 'ì œì£¼ ì‚°ë°©ì‚°' },
        'ì œì£¼ì˜¬ë ˆì—¬í–‰ìì„¼í„°': { lat: 33.2483, lon: 126.5649, name: 'ì œì£¼ì˜¬ë ˆì—¬í–‰ìì„¼í„°' },
        'ì„œê·€í¬ë²„ìŠ¤í„°ë¯¸ë„': { lat: 33.2546, lon: 126.5685, name: 'ì„œê·€í¬ë²„ìŠ¤í„°ë¯¸ë„' },
        'ì™¸ëŒê°œ': { lat: 33.2386, lon: 126.5413, name: 'ì™¸ëŒê°œ' },
        'ë²•í™˜í¬êµ¬': { lat: 33.2366, lon: 126.5165, name: 'ë²•í™˜í¬êµ¬' },
        'ë²•í™˜ë™': { lat: 33.2427, lon: 126.5165, name: 'ì œì£¼ ì„œê·€í¬ì‹œ ë²•í™˜ë™' },
        'ì¤‘ì•™ë™': { lat: 33.2482, lon: 126.5657, name: 'ì œì£¼ ì„œê·€í¬ì‹œ ì¤‘ì•™ë™' },
        'ì •ë°©ë™': { lat: 33.2514, lon: 126.5707, name: 'ì œì£¼ ì„œê·€í¬ì‹œ ì •ë°©ë™' },
        'ì²œì§€ë™': { lat: 33.2492, lon: 126.5623, name: 'ì œì£¼ ì„œê·€í¬ì‹œ ì²œì§€ë™' },
        'ë™í™ë™': { lat: 33.2588, lon: 126.5739, name: 'ì œì£¼ ì„œê·€í¬ì‹œ ë™í™ë™' },
        'ì„œí™ë™': { lat: 33.2575, lon: 126.5501, name: 'ì œì£¼ ì„œê·€í¬ì‹œ ì„œí™ë™' },
        'ëŒ€ë¥œë™': { lat: 33.2384, lon: 126.5385, name: 'ì œì£¼ ì„œê·€í¬ì‹œ ëŒ€ë¥œë™' },
        'ëŒ€ì²œë™': { lat: 33.2559, lon: 126.4950, name: 'ì œì£¼ ì„œê·€í¬ì‹œ ëŒ€ì²œë™' },
        'ì¤‘ë¬¸ë™': { lat: 33.2545, lon: 126.4103, name: 'ì œì£¼ ì„œê·€í¬ì‹œ ì¤‘ë¬¸ë™' },
        'ì˜ˆë˜ë™': { lat: 33.2505, lon: 126.3685, name: 'ì œì£¼ ì„œê·€í¬ì‹œ ì˜ˆë˜ë™' },
        'ê°•ì •ë™': { lat: 33.2507, lon: 126.5054, name: 'ì œì£¼ ì„œê·€í¬ì‹œ ê°•ì •ë™' },
        'í•˜íš¨ë™': { lat: 33.2625, lon: 126.6023, name: 'ì œì£¼ ì„œê·€í¬ì‹œ í•˜íš¨ë™' },
        'ìƒ‰ë‹¬ë™': { lat: 33.2482, lon: 126.4026, name: 'ì œì£¼ ì„œê·€í¬ì‹œ ìƒ‰ë‹¬ë™' },
        'ì„œê·€ë™': { lat: 33.2503, lon: 126.5668, name: 'ì œì£¼ ì„œê·€í¬ì‹œ ì„œê·€ë™' },
        
        // ê²½ê¸°ë„ ì£¼ìš” ë„ì‹œ
        'ìˆ˜ì›': { lat: 37.2636, lon: 127.0286, name: 'ê²½ê¸°ë„ ìˆ˜ì›ì‹œ' },
        'ìˆ˜ì›ì‹œ': { lat: 37.2636, lon: 127.0286, name: 'ê²½ê¸°ë„ ìˆ˜ì›ì‹œ' },
        'ì„±ë‚¨': { lat: 37.4449, lon: 127.1389, name: 'ê²½ê¸°ë„ ì„±ë‚¨ì‹œ' },
        'ì„±ë‚¨ì‹œ': { lat: 37.4449, lon: 127.1389, name: 'ê²½ê¸°ë„ ì„±ë‚¨ì‹œ' },
        'ìš©ì¸': { lat: 37.2411, lon: 127.1776, name: 'ê²½ê¸°ë„ ìš©ì¸ì‹œ' },
        'ìš©ì¸ì‹œ': { lat: 37.2411, lon: 127.1776, name: 'ê²½ê¸°ë„ ìš©ì¸ì‹œ' },
        'êµ¬ë¦¬': { lat: 37.5943, lon: 127.1296, name: 'ê²½ê¸°ë„ êµ¬ë¦¬ì‹œ' },
        'êµ¬ë¦¬ì‹œ': { lat: 37.5943, lon: 127.1296, name: 'ê²½ê¸°ë„ êµ¬ë¦¬ì‹œ' },
        'ì•ˆì–‘': { lat: 37.3943, lon: 126.9568, name: 'ê²½ê¸°ë„ ì•ˆì–‘ì‹œ' },
        'ì•ˆì–‘ì‹œ': { lat: 37.3943, lon: 126.9568, name: 'ê²½ê¸°ë„ ì•ˆì–‘ì‹œ' },
        'ë¶€ì²œ': { lat: 37.5034, lon: 126.7660, name: 'ê²½ê¸°ë„ ë¶€ì²œì‹œ' },
        'ë¶€ì²œì‹œ': { lat: 37.5034, lon: 126.7660, name: 'ê²½ê¸°ë„ ë¶€ì²œì‹œ' },
        'ê´‘ëª…': { lat: 37.4786, lon: 126.8644, name: 'ê²½ê¸°ë„ ê´‘ëª…ì‹œ' },
        'ê´‘ëª…ì‹œ': { lat: 37.4786, lon: 126.8644, name: 'ê²½ê¸°ë„ ê´‘ëª…ì‹œ' },
        'í‰íƒ': { lat: 36.9921, lon: 127.1127, name: 'ê²½ê¸°ë„ í‰íƒì‹œ' },
        'í‰íƒì‹œ': { lat: 36.9921, lon: 127.1127, name: 'ê²½ê¸°ë„ í‰íƒì‹œ' },
        'ê³¼ì²œ': { lat: 37.4292, lon: 126.9875, name: 'ê²½ê¸°ë„ ê³¼ì²œì‹œ' },
        'ê³¼ì²œì‹œ': { lat: 37.4292, lon: 126.9875, name: 'ê²½ê¸°ë„ ê³¼ì²œì‹œ' },
        'ì˜¤ì‚°': { lat: 37.1498, lon: 127.0772, name: 'ê²½ê¸°ë„ ì˜¤ì‚°ì‹œ' },
        'ì˜¤ì‚°ì‹œ': { lat: 37.1498, lon: 127.0772, name: 'ê²½ê¸°ë„ ì˜¤ì‚°ì‹œ' },
        'ì‹œí¥': { lat: 37.3802, lon: 126.8028, name: 'ê²½ê¸°ë„ ì‹œí¥ì‹œ' },
        'ì‹œí¥ì‹œ': { lat: 37.3802, lon: 126.8028, name: 'ê²½ê¸°ë„ ì‹œí¥ì‹œ' },
        'êµ°í¬': { lat: 37.3617, lon: 126.9352, name: 'ê²½ê¸°ë„ êµ°í¬ì‹œ' },
        'êµ°í¬ì‹œ': { lat: 37.3617, lon: 126.9352, name: 'ê²½ê¸°ë„ êµ°í¬ì‹œ' },
        'ì˜ì™•': { lat: 37.3448, lon: 126.9683, name: 'ê²½ê¸°ë„ ì˜ì™•ì‹œ' },
        'ì˜ì™•ì‹œ': { lat: 37.3448, lon: 126.9683, name: 'ê²½ê¸°ë„ ì˜ì™•ì‹œ' },
        'í•˜ë‚¨': { lat: 37.5393, lon: 127.2147, name: 'ê²½ê¸°ë„ í•˜ë‚¨ì‹œ' },
        'í•˜ë‚¨ì‹œ': { lat: 37.5393, lon: 127.2147, name: 'ê²½ê¸°ë„ í•˜ë‚¨ì‹œ' },
        'ì´ì²œ': { lat: 37.2720, lon: 127.4347, name: 'ê²½ê¸°ë„ ì´ì²œì‹œ' },
        'ì´ì²œì‹œ': { lat: 37.2720, lon: 127.4347, name: 'ê²½ê¸°ë„ ì´ì²œì‹œ' },
        'ì•ˆì„±': { lat: 37.0080, lon: 127.2798, name: 'ê²½ê¸°ë„ ì•ˆì„±ì‹œ' },
        'ì•ˆì„±ì‹œ': { lat: 37.0080, lon: 127.2798, name: 'ê²½ê¸°ë„ ì•ˆì„±ì‹œ' },
        'ê¹€í¬': { lat: 37.6152, lon: 126.7156, name: 'ê²½ê¸°ë„ ê¹€í¬ì‹œ' },
        'ê¹€í¬ì‹œ': { lat: 37.6152, lon: 126.7156, name: 'ê²½ê¸°ë„ ê¹€í¬ì‹œ' },
        'í™”ì„±': { lat: 37.1995, lon: 126.8312, name: 'ê²½ê¸°ë„ í™”ì„±ì‹œ' },
        'í™”ì„±ì‹œ': { lat: 37.1995, lon: 126.8312, name: 'ê²½ê¸°ë„ í™”ì„±ì‹œ' },
        'ê´‘ì£¼ì‹œ': { lat: 37.4294, lon: 127.2551, name: 'ê²½ê¸°ë„ ê´‘ì£¼ì‹œ' },
        'ì–‘ì£¼': { lat: 37.7852, lon: 127.0459, name: 'ê²½ê¸°ë„ ì–‘ì£¼ì‹œ' },
        'ì–‘ì£¼ì‹œ': { lat: 37.7852, lon: 127.0459, name: 'ê²½ê¸°ë„ ì–‘ì£¼ì‹œ' },
        'í¬ì²œ': { lat: 37.8950, lon: 127.2003, name: 'ê²½ê¸°ë„ í¬ì²œì‹œ' },
        'í¬ì²œì‹œ': { lat: 37.8950, lon: 127.2003, name: 'ê²½ê¸°ë„ í¬ì²œì‹œ' },
        'ì—¬ì£¼': { lat: 37.2982, lon: 127.6367, name: 'ê²½ê¸°ë„ ì—¬ì£¼ì‹œ' },
        'ì—¬ì£¼ì‹œ': { lat: 37.2982, lon: 127.6367, name: 'ê²½ê¸°ë„ ì—¬ì£¼ì‹œ' },
        'ì—°ì²œ': { lat: 38.0963, lon: 127.0749, name: 'ê²½ê¸°ë„ ì—°ì²œêµ°' },
        'ì—°ì²œêµ°': { lat: 38.0963, lon: 127.0749, name: 'ê²½ê¸°ë„ ì—°ì²œêµ°' },
        'ê°€í‰': { lat: 37.8315, lon: 127.5095, name: 'ê²½ê¸°ë„ ê°€í‰êµ°' },
        'ê°€í‰êµ°': { lat: 37.8315, lon: 127.5095, name: 'ê²½ê¸°ë„ ê°€í‰êµ°' },
        'ì–‘í‰': { lat: 37.4917, lon: 127.4875, name: 'ê²½ê¸°ë„ ì–‘í‰êµ°' },
        'ì–‘í‰êµ°': { lat: 37.4917, lon: 127.4875, name: 'ê²½ê¸°ë„ ì–‘í‰êµ°' },
        
        // ê²½ìƒë¶ë„ ì£¼ìš” ë„ì‹œ
        'ê²½ì‚°': { lat: 35.8241, lon: 128.7408, name: 'ê²½ìƒë¶ë„ ê²½ì‚°ì‹œ' },
        'ê²½ì‚°ì‹œ': { lat: 35.8241, lon: 128.7408, name: 'ê²½ìƒë¶ë„ ê²½ì‚°ì‹œ' },
        'í¬í•­': { lat: 36.0190, lon: 129.3435, name: 'ê²½ìƒë¶ë„ í¬í•­ì‹œ' },
        'í¬í•­ì‹œ': { lat: 36.0190, lon: 129.3435, name: 'ê²½ìƒë¶ë„ í¬í•­ì‹œ' },
        'ê²½ì£¼': { lat: 35.8562, lon: 129.2246, name: 'ê²½ìƒë¶ë„ ê²½ì£¼ì‹œ' },
        'ê²½ì£¼ì‹œ': { lat: 35.8562, lon: 129.2246, name: 'ê²½ìƒë¶ë„ ê²½ì£¼ì‹œ' },
        'ê¹€ì²œ': { lat: 36.1398, lon: 128.1136, name: 'ê²½ìƒë¶ë„ ê¹€ì²œì‹œ' },
        'ê¹€ì²œì‹œ': { lat: 36.1398, lon: 128.1136, name: 'ê²½ìƒë¶ë„ ê¹€ì²œì‹œ' },
        'ì•ˆë™': { lat: 36.5684, lon: 128.7294, name: 'ê²½ìƒë¶ë„ ì•ˆë™ì‹œ' },
        'ì•ˆë™ì‹œ': { lat: 36.5684, lon: 128.7294, name: 'ê²½ìƒë¶ë„ ì•ˆë™ì‹œ' },
        'êµ¬ë¯¸': { lat: 36.1195, lon: 128.3446, name: 'ê²½ìƒë¶ë„ êµ¬ë¯¸ì‹œ' },
        'êµ¬ë¯¸ì‹œ': { lat: 36.1195, lon: 128.3446, name: 'ê²½ìƒë¶ë„ êµ¬ë¯¸ì‹œ' },
        'ì˜ì£¼': { lat: 36.8057, lon: 128.6240, name: 'ê²½ìƒë¶ë„ ì˜ì£¼ì‹œ' },
        'ì˜ì£¼ì‹œ': { lat: 36.8057, lon: 128.6240, name: 'ê²½ìƒë¶ë„ ì˜ì£¼ì‹œ' },
        'ì˜ì²œ': { lat: 35.9733, lon: 128.9386, name: 'ê²½ìƒë¶ë„ ì˜ì²œì‹œ' },
        'ì˜ì²œì‹œ': { lat: 35.9733, lon: 128.9386, name: 'ê²½ìƒë¶ë„ ì˜ì²œì‹œ' },
        'ìƒì£¼': { lat: 36.4109, lon: 128.1591, name: 'ê²½ìƒë¶ë„ ìƒì£¼ì‹œ' },
        'ìƒì£¼ì‹œ': { lat: 36.4109, lon: 128.1591, name: 'ê²½ìƒë¶ë„ ìƒì£¼ì‹œ' },
        'ë¬¸ê²½': { lat: 36.5865, lon: 128.1868, name: 'ê²½ìƒë¶ë„ ë¬¸ê²½ì‹œ' },
        'ë¬¸ê²½ì‹œ': { lat: 36.5865, lon: 128.1868, name: 'ê²½ìƒë¶ë„ ë¬¸ê²½ì‹œ' },
        'ê²½ì‚°ì¤‘ë°©ë™': { lat: 35.8198, lon: 128.7441, name: 'ê²½ìƒë¶ë„ ê²½ì‚°ì‹œ ì¤‘ë°©ë™' },
        'ì¤‘ë°©ë™': { lat: 35.8198, lon: 128.7441, name: 'ê²½ìƒë¶ë„ ê²½ì‚°ì‹œ ì¤‘ë°©ë™' },
        
        // ê²½ìƒë‚¨ë„ ì£¼ìš” ë„ì‹œ
        'ì°½ì›': { lat: 35.2280, lon: 128.6811, name: 'ê²½ìƒë‚¨ë„ ì°½ì›ì‹œ' },
        'ì°½ì›ì‹œ': { lat: 35.2280, lon: 128.6811, name: 'ê²½ìƒë‚¨ë„ ì°½ì›ì‹œ' },
        'ì§„ì£¼': { lat: 35.1800, lon: 128.1076, name: 'ê²½ìƒë‚¨ë„ ì§„ì£¼ì‹œ' },
        'ì§„ì£¼ì‹œ': { lat: 35.1800, lon: 128.1076, name: 'ê²½ìƒë‚¨ë„ ì§„ì£¼ì‹œ' },
        'í†µì˜': { lat: 34.8544, lon: 128.4332, name: 'ê²½ìƒë‚¨ë„ í†µì˜ì‹œ' },
        'í†µì˜ì‹œ': { lat: 34.8544, lon: 128.4332, name: 'ê²½ìƒë‚¨ë„ í†µì˜ì‹œ' },
        'ì‚¬ì²œ': { lat: 35.0038, lon: 128.0640, name: 'ê²½ìƒë‚¨ë„ ì‚¬ì²œì‹œ' },
        'ì‚¬ì²œì‹œ': { lat: 35.0038, lon: 128.0640, name: 'ê²½ìƒë‚¨ë„ ì‚¬ì²œì‹œ' },
        'ê¹€í•´': { lat: 35.2285, lon: 128.8893, name: 'ê²½ìƒë‚¨ë„ ê¹€í•´ì‹œ' },
        'ê¹€í•´ì‹œ': { lat: 35.2285, lon: 128.8893, name: 'ê²½ìƒë‚¨ë„ ê¹€í•´ì‹œ' },
        'ë°€ì–‘': { lat: 35.5037, lon: 128.7486, name: 'ê²½ìƒë‚¨ë„ ë°€ì–‘ì‹œ' },
        'ë°€ì–‘ì‹œ': { lat: 35.5037, lon: 128.7486, name: 'ê²½ìƒë‚¨ë„ ë°€ì–‘ì‹œ' },
        'ê±°ì œ': { lat: 34.8806, lon: 128.6211, name: 'ê²½ìƒë‚¨ë„ ê±°ì œì‹œ' },
        'ê±°ì œì‹œ': { lat: 34.8806, lon: 128.6211, name: 'ê²½ìƒë‚¨ë„ ê±°ì œì‹œ' },
        'ì–‘ì‚°': { lat: 35.3350, lon: 129.0377, name: 'ê²½ìƒë‚¨ë„ ì–‘ì‚°ì‹œ' },
        'ì–‘ì‚°ì‹œ': { lat: 35.3350, lon: 129.0377, name: 'ê²½ìƒë‚¨ë„ ì–‘ì‚°ì‹œ' },
        
        // ì „ë¼ë¶ë„ ì£¼ìš” ë„ì‹œ
        'ì „ì£¼': { lat: 35.8242, lon: 127.1480, name: 'ì „ë¼ë¶ë„ ì „ì£¼ì‹œ' },
        'ì „ì£¼ì‹œ': { lat: 35.8242, lon: 127.1480, name: 'ì „ë¼ë¶ë„ ì „ì£¼ì‹œ' },
        'êµ°ì‚°': { lat: 35.9677, lon: 126.7366, name: 'ì „ë¼ë¶ë„ êµ°ì‚°ì‹œ' },
        'êµ°ì‚°ì‹œ': { lat: 35.9677, lon: 126.7366, name: 'ì „ë¼ë¶ë„ êµ°ì‚°ì‹œ' },
        'ìµì‚°': { lat: 35.9483, lon: 126.9576, name: 'ì „ë¼ë¶ë„ ìµì‚°ì‹œ' },
        'ìµì‚°ì‹œ': { lat: 35.9483, lon: 126.9576, name: 'ì „ë¼ë¶ë„ ìµì‚°ì‹œ' },
        'ì •ì': { lat: 35.5699, lon: 126.8559, name: 'ì „ë¼ë¶ë„ ì •ìì‹œ' },
        'ì •ìì‹œ': { lat: 35.5699, lon: 126.8559, name: 'ì „ë¼ë¶ë„ ì •ìì‹œ' },
        'ë‚¨ì›': { lat: 35.4164, lon: 127.3903, name: 'ì „ë¼ë¶ë„ ë‚¨ì›ì‹œ' },
        'ë‚¨ì›ì‹œ': { lat: 35.4164, lon: 127.3903, name: 'ì „ë¼ë¶ë„ ë‚¨ì›ì‹œ' },
        'ê¹€ì œ': { lat: 35.8036, lon: 126.8809, name: 'ì „ë¼ë¶ë„ ê¹€ì œì‹œ' },
        'ê¹€ì œì‹œ': { lat: 35.8036, lon: 126.8809, name: 'ì „ë¼ë¶ë„ ê¹€ì œì‹œ' },
        
        // ì „ë¼ë‚¨ë„ ì£¼ìš” ë„ì‹œ
        'ëª©í¬': { lat: 34.8118, lon: 126.3922, name: 'ì „ë¼ë‚¨ë„ ëª©í¬ì‹œ' },
        'ëª©í¬ì‹œ': { lat: 34.8118, lon: 126.3922, name: 'ì „ë¼ë‚¨ë„ ëª©í¬ì‹œ' },
        'ì—¬ìˆ˜': { lat: 34.7604, lon: 127.6622, name: 'ì „ë¼ë‚¨ë„ ì—¬ìˆ˜ì‹œ' },
        'ì—¬ìˆ˜ì‹œ': { lat: 34.7604, lon: 127.6622, name: 'ì „ë¼ë‚¨ë„ ì—¬ìˆ˜ì‹œ' },
        'ìˆœì²œ': { lat: 34.9507, lon: 127.4872, name: 'ì „ë¼ë‚¨ë„ ìˆœì²œì‹œ' },
        'ìˆœì²œì‹œ': { lat: 34.9507, lon: 127.4872, name: 'ì „ë¼ë‚¨ë„ ìˆœì²œì‹œ' },
        'ë‚˜ì£¼': { lat: 35.0160, lon: 126.7108, name: 'ì „ë¼ë‚¨ë„ ë‚˜ì£¼ì‹œ' },
        'ë‚˜ì£¼ì‹œ': { lat: 35.0160, lon: 126.7108, name: 'ì „ë¼ë‚¨ë„ ë‚˜ì£¼ì‹œ' },
        'ê´‘ì–‘': { lat: 34.9407, lon: 127.6956, name: 'ì „ë¼ë‚¨ë„ ê´‘ì–‘ì‹œ' },
        'ê´‘ì–‘ì‹œ': { lat: 34.9407, lon: 127.6956, name: 'ì „ë¼ë‚¨ë„ ê´‘ì–‘ì‹œ' },
        
        // ì¶©ì²­ë¶ë„ ì£¼ìš” ë„ì‹œ
        'ì²­ì£¼': { lat: 36.6424, lon: 127.4890, name: 'ì¶©ì²­ë¶ë„ ì²­ì£¼ì‹œ' },
        'ì²­ì£¼ì‹œ': { lat: 36.6424, lon: 127.4890, name: 'ì¶©ì²­ë¶ë„ ì²­ì£¼ì‹œ' },
        'ì¶©ì£¼': { lat: 36.9910, lon: 127.9259, name: 'ì¶©ì²­ë¶ë„ ì¶©ì£¼ì‹œ' },
        'ì¶©ì£¼ì‹œ': { lat: 36.9910, lon: 127.9259, name: 'ì¶©ì²­ë¶ë„ ì¶©ì£¼ì‹œ' },
        'ì œì²œ': { lat: 37.1326, lon: 128.1909, name: 'ì¶©ì²­ë¶ë„ ì œì²œì‹œ' },
        'ì œì²œì‹œ': { lat: 37.1326, lon: 128.1909, name: 'ì¶©ì²­ë¶ë„ ì œì²œì‹œ' },
        
        // ì¶©ì²­ë‚¨ë„ ì£¼ìš” ë„ì‹œ
        'ì²œì•ˆ': { lat: 36.8151, lon: 127.1139, name: 'ì¶©ì²­ë‚¨ë„ ì²œì•ˆì‹œ' },
        'ì²œì•ˆì‹œ': { lat: 36.8151, lon: 127.1139, name: 'ì¶©ì²­ë‚¨ë„ ì²œì•ˆì‹œ' },
        'ê³µì£¼': { lat: 36.4466, lon: 127.1190, name: 'ì¶©ì²­ë‚¨ë„ ê³µì£¼ì‹œ' },
        'ê³µì£¼ì‹œ': { lat: 36.4466, lon: 127.1190, name: 'ì¶©ì²­ë‚¨ë„ ê³µì£¼ì‹œ' },
        'ë³´ë ¹': { lat: 36.3333, lon: 126.6129, name: 'ì¶©ì²­ë‚¨ë„ ë³´ë ¹ì‹œ' },
        'ë³´ë ¹ì‹œ': { lat: 36.3333, lon: 126.6129, name: 'ì¶©ì²­ë‚¨ë„ ë³´ë ¹ì‹œ' },
        'ì•„ì‚°': { lat: 36.7898, lon: 127.0019, name: 'ì¶©ì²­ë‚¨ë„ ì•„ì‚°ì‹œ' },
        'ì•„ì‚°ì‹œ': { lat: 36.7898, lon: 127.0019, name: 'ì¶©ì²­ë‚¨ë„ ì•„ì‚°ì‹œ' },
        'ì„œì‚°': { lat: 36.7845, lon: 126.4503, name: 'ì¶©ì²­ë‚¨ë„ ì„œì‚°ì‹œ' },
        'ì„œì‚°ì‹œ': { lat: 36.7845, lon: 126.4503, name: 'ì¶©ì²­ë‚¨ë„ ì„œì‚°ì‹œ' },
        'ë…¼ì‚°': { lat: 36.1872, lon: 127.0987, name: 'ì¶©ì²­ë‚¨ë„ ë…¼ì‚°ì‹œ' },
        'ë…¼ì‚°ì‹œ': { lat: 36.1872, lon: 127.0987, name: 'ì¶©ì²­ë‚¨ë„ ë…¼ì‚°ì‹œ' },
        'ê³„ë£¡': { lat: 36.2745, lon: 127.2487, name: 'ì¶©ì²­ë‚¨ë„ ê³„ë£¡ì‹œ' },
        'ê³„ë£¡ì‹œ': { lat: 36.2745, lon: 127.2487, name: 'ì¶©ì²­ë‚¨ë„ ê³„ë£¡ì‹œ' },
        'ë‹¹ì§„': { lat: 36.8896, lon: 126.6299, name: 'ì¶©ì²­ë‚¨ë„ ë‹¹ì§„ì‹œ' },
        'ë‹¹ì§„ì‹œ': { lat: 36.8896, lon: 126.6299, name: 'ì¶©ì²­ë‚¨ë„ ë‹¹ì§„ì‹œ' },
        
        // ê°•ì›ë„ ì£¼ìš” ë„ì‹œ
        'ì¶˜ì²œ': { lat: 37.8813, lon: 127.7298, name: 'ê°•ì›ë„ ì¶˜ì²œì‹œ' },
        'ì¶˜ì²œì‹œ': { lat: 37.8813, lon: 127.7298, name: 'ê°•ì›ë„ ì¶˜ì²œì‹œ' },
        'ì›ì£¼': { lat: 37.3422, lon: 127.9202, name: 'ê°•ì›ë„ ì›ì£¼ì‹œ' },
        'ì›ì£¼ì‹œ': { lat: 37.3422, lon: 127.9202, name: 'ê°•ì›ë„ ì›ì£¼ì‹œ' },
        'ê°•ë¦‰': { lat: 37.7519, lon: 128.8761, name: 'ê°•ì›ë„ ê°•ë¦‰ì‹œ' },
        'ê°•ë¦‰ì‹œ': { lat: 37.7519, lon: 128.8761, name: 'ê°•ì›ë„ ê°•ë¦‰ì‹œ' },
        'ë™í•´': { lat: 37.5247, lon: 129.1144, name: 'ê°•ì›ë„ ë™í•´ì‹œ' },
        'ë™í•´ì‹œ': { lat: 37.5247, lon: 129.1144, name: 'ê°•ì›ë„ ë™í•´ì‹œ' },
        'íƒœë°±': { lat: 37.1640, lon: 128.9856, name: 'ê°•ì›ë„ íƒœë°±ì‹œ' },
        'íƒœë°±ì‹œ': { lat: 37.1640, lon: 128.9856, name: 'ê°•ì›ë„ íƒœë°±ì‹œ' },
        'ì†ì´ˆ': { lat: 38.2070, lon: 128.5918, name: 'ê°•ì›ë„ ì†ì´ˆì‹œ' },
        'ì†ì´ˆì‹œ': { lat: 38.2070, lon: 128.5918, name: 'ê°•ì›ë„ ì†ì´ˆì‹œ' },
        'ì‚¼ì²™': { lat: 37.4499, lon: 129.1651, name: 'ê°•ì›ë„ ì‚¼ì²™ì‹œ' },
        'ì‚¼ì²™ì‹œ': { lat: 37.4499, lon: 129.1651, name: 'ê°•ì›ë„ ì‚¼ì²™ì‹œ' },
        
        // ì„œìš¸ ì§€ì—­ ì¶”ê°€ (í…ŒìŠ¤íŠ¸ ë° ê°•í™” ëª©ì )
        'ê°•ë‚¨êµ¬': { lat: 37.5172, lon: 127.0473, name: 'ì„œìš¸íŠ¹ë³„ì‹œ ê°•ë‚¨êµ¬' },
        'ì¢…ë¡œêµ¬': { lat: 37.5702, lon: 126.9790, name: 'ì„œìš¸íŠ¹ë³„ì‹œ ì¢…ë¡œêµ¬' },
        'ì¤‘êµ¬': { lat: 37.5637, lon: 126.9975, name: 'ì„œìš¸íŠ¹ë³„ì‹œ ì¤‘êµ¬' },
        'ìš©ì‚°êµ¬': { lat: 37.5326, lon: 126.9905, name: 'ì„œìš¸íŠ¹ë³„ì‹œ ìš©ì‚°êµ¬' },
        'ì„±ë™êµ¬': { lat: 37.5634, lon: 127.0370, name: 'ì„œìš¸íŠ¹ë³„ì‹œ ì„±ë™êµ¬' },
        'ê´‘ì§„êµ¬': { lat: 37.5385, lon: 127.0823, name: 'ì„œìš¸íŠ¹ë³„ì‹œ ê´‘ì§„êµ¬' },
        'ë™ëŒ€ë¬¸êµ¬': { lat: 37.5744, lon: 127.0400, name: 'ì„œìš¸íŠ¹ë³„ì‹œ ë™ëŒ€ë¬¸êµ¬' },
        'ì¤‘ë‘êµ¬': { lat: 37.6063, lon: 127.0928, name: 'ì„œìš¸íŠ¹ë³„ì‹œ ì¤‘ë‘êµ¬' },
        'ì„±ë¶êµ¬': { lat: 37.5894, lon: 127.0167, name: 'ì„œìš¸íŠ¹ë³„ì‹œ ì„±ë¶êµ¬' },
        'ê°•ë¶êµ¬': { lat: 37.6396, lon: 127.0256, name: 'ì„œìš¸íŠ¹ë³„ì‹œ ê°•ë¶êµ¬' },
        'ë„ë´‰êµ¬': { lat: 37.6688, lon: 127.0471, name: 'ì„œìš¸íŠ¹ë³„ì‹œ ë„ë´‰êµ¬' },
        'ë…¸ì›êµ¬': { lat: 37.6543, lon: 127.0568, name: 'ì„œìš¸íŠ¹ë³„ì‹œ ë…¸ì›êµ¬' },
        'ì€í‰êµ¬': { lat: 37.6177, lon: 126.9227, name: 'ì„œìš¸íŠ¹ë³„ì‹œ ì€í‰êµ¬' },
        'ì„œëŒ€ë¬¸êµ¬': { lat: 37.5791, lon: 126.9368, name: 'ì„œìš¸íŠ¹ë³„ì‹œ ì„œëŒ€ë¬¸êµ¬' },
        'ë§ˆí¬êµ¬': { lat: 37.5664, lon: 126.9015, name: 'ì„œìš¸íŠ¹ë³„ì‹œ ë§ˆí¬êµ¬' },
        'ì–‘ì²œêµ¬': { lat: 37.5170, lon: 126.8664, name: 'ì„œìš¸íŠ¹ë³„ì‹œ ì–‘ì²œêµ¬' },
        'ê°•ì„œêµ¬': { lat: 37.5509, lon: 126.8495, name: 'ì„œìš¸íŠ¹ë³„ì‹œ ê°•ì„œêµ¬' },
        'êµ¬ë¡œêµ¬': { lat: 37.4955, lon: 126.8874, name: 'ì„œìš¸íŠ¹ë³„ì‹œ êµ¬ë¡œêµ¬' },
        'ê¸ˆì²œêµ¬': { lat: 37.4519, lon: 126.8954, name: 'ì„œìš¸íŠ¹ë³„ì‹œ ê¸ˆì²œêµ¬' },
        'ì˜ë“±í¬êµ¬': { lat: 37.5264, lon: 126.8963, name: 'ì„œìš¸íŠ¹ë³„ì‹œ ì˜ë“±í¬êµ¬' },
        'ë™ì‘êµ¬': { lat: 37.5124, lon: 126.9393, name: 'ì„œìš¸íŠ¹ë³„ì‹œ ë™ì‘êµ¬' },
        'ê´€ì•…êµ¬': { lat: 37.4784, lon: 126.9516, name: 'ì„œìš¸íŠ¹ë³„ì‹œ ê´€ì•…êµ¬' },
        'ì„œì´ˆêµ¬': { lat: 37.4836, lon: 127.0327, name: 'ì„œìš¸íŠ¹ë³„ì‹œ ì„œì´ˆêµ¬' },
        'ì†¡íŒŒêµ¬': { lat: 37.5145, lon: 127.1060, name: 'ì„œìš¸íŠ¹ë³„ì‹œ ì†¡íŒŒêµ¬' },
        'ê°•ë™êµ¬': { lat: 37.5301, lon: 127.1238, name: 'ì„œìš¸íŠ¹ë³„ì‹œ ê°•ë™êµ¬' },
        
        // ì„œìš¸ ì£¼ìš” ë™ ì§€ì—­
        'ì—­ì‚¼ë™': { lat: 37.4998, lon: 127.0374, name: 'ì„œìš¸íŠ¹ë³„ì‹œ ê°•ë‚¨êµ¬ ì—­ì‚¼ë™' },
        'ê°€ë¡œìˆ˜ê¸¸': { lat: 37.5218, lon: 127.0219, name: 'ì„œìš¸íŠ¹ë³„ì‹œ ê°•ë‚¨êµ¬ ì‹ ì‚¬ë™' },
        'í™ëŒ€': { lat: 37.5577, lon: 126.9246, name: 'ì„œìš¸íŠ¹ë³„ì‹œ ë§ˆí¬êµ¬ í™ëŒ€ì…êµ¬ì—­' },
        'ì—¬ì˜ë„ë™': { lat: 37.5251, lon: 126.9243, name: 'ì„œìš¸íŠ¹ë³„ì‹œ ì˜ë“±í¬êµ¬ ì—¬ì˜ë„ë™' },
        'ëª…ë™': { lat: 37.5636, lon: 126.9822, name: 'ì„œìš¸íŠ¹ë³„ì‹œ ì¤‘êµ¬ ëª…ë™' },
        'ì²­ë‹´ë™': { lat: 37.5235, lon: 127.0470, name: 'ì„œìš¸íŠ¹ë³„ì‹œ ê°•ë‚¨êµ¬ ì²­ë‹´ë™' },
        'ì‹ ì‚¬ë™': { lat: 37.5204, lon: 127.0205, name: 'ì„œìš¸íŠ¹ë³„ì‹œ ê°•ë‚¨êµ¬ ì‹ ì‚¬ë™' },
        'ë…¼í˜„ë™': { lat: 37.5103, lon: 127.0226, name: 'ì„œìš¸íŠ¹ë³„ì‹œ ê°•ë‚¨êµ¬ ë…¼í˜„ë™' },
        'ì‚¼ì„±ë™': { lat: 37.5088, lon: 127.0630, name: 'ì„œìš¸íŠ¹ë³„ì‹œ ê°•ë‚¨êµ¬ ì‚¼ì„±ë™' },
        'ëŒ€ì¹˜ë™': { lat: 37.4968, lon: 127.0582, name: 'ì„œìš¸íŠ¹ë³„ì‹œ ê°•ë‚¨êµ¬ ëŒ€ì¹˜ë™' },
        'ê°œí¬ë™': { lat: 37.4896, lon: 127.0664, name: 'ì„œìš¸íŠ¹ë³„ì‹œ ê°•ë‚¨êµ¬ ê°œí¬ë™' },
        'ì¼ì›ë™': { lat: 37.4910, lon: 127.0842, name: 'ì„œìš¸íŠ¹ë³„ì‹œ ê°•ë‚¨êµ¬ ì¼ì›ë™' },
        'ìˆ˜ì„œë™': { lat: 37.4878, lon: 127.1013, name: 'ì„œìš¸íŠ¹ë³„ì‹œ ê°•ë‚¨êµ¬ ìˆ˜ì„œë™' },
        'ì„¸ê³¡ë™': { lat: 37.4651, lon: 127.1058, name: 'ì„œìš¸íŠ¹ë³„ì‹œ ê°•ë‚¨êµ¬ ì„¸ê³¡ë™' },
        
        // ëŒ€êµ¬ ìˆ˜ì„±êµ¬
        'ìˆ˜ì„±êµ¬': { lat: 35.8581, lon: 128.6308, name: 'ëŒ€êµ¬ê´‘ì—­ì‹œ ìˆ˜ì„±êµ¬' },
        'ìˆ˜ì„±1ê°€': { lat: 35.8450, lon: 128.6186, name: 'ëŒ€êµ¬ê´‘ì—­ì‹œ ìˆ˜ì„±êµ¬ ìˆ˜ì„±1ê°€' },
        'ìˆ˜ì„±2ê°€': { lat: 35.8433, lon: 128.6214, name: 'ëŒ€êµ¬ê´‘ì—­ì‹œ ìˆ˜ì„±êµ¬ ìˆ˜ì„±2ê°€' },
        'ìˆ˜ì„±3ê°€': { lat: 35.8415, lon: 128.6241, name: 'ëŒ€êµ¬ê´‘ì—­ì‹œ ìˆ˜ì„±êµ¬ ìˆ˜ì„±3ê°€' },
        'ìˆ˜ì„±4ê°€': { lat: 35.8398, lon: 128.6269, name: 'ëŒ€êµ¬ê´‘ì—­ì‹œ ìˆ˜ì„±êµ¬ ìˆ˜ì„±4ê°€' },
        'ë²”ì–´ë™': { lat: 35.8626, lon: 128.6246, name: 'ëŒ€êµ¬ê´‘ì—­ì‹œ ìˆ˜ì„±êµ¬ ë²”ì–´ë™' },
        'ë§Œì´Œë™': { lat: 35.8774, lon: 128.6523, name: 'ëŒ€êµ¬ê´‘ì—­ì‹œ ìˆ˜ì„±êµ¬ ë§Œì´Œë™' },
        'í™©ê¸ˆë™': { lat: 35.8487, lon: 128.6280, name: 'ëŒ€êµ¬ê´‘ì—­ì‹œ ìˆ˜ì„±êµ¬ í™©ê¸ˆë™' },
        'ì¤‘ë™': { lat: 35.8546, lon: 128.6156, name: 'ëŒ€êµ¬ê´‘ì—­ì‹œ ìˆ˜ì„±êµ¬ ì¤‘ë™' },
        'ìƒë™': { lat: 35.8604, lon: 128.6032, name: 'ëŒ€êµ¬ê´‘ì—­ì‹œ ìˆ˜ì„±êµ¬ ìƒë™' },
        'íŒŒë™': { lat: 35.8130, lon: 128.6097, name: 'ëŒ€êµ¬ê´‘ì—­ì‹œ ìˆ˜ì„±êµ¬ íŒŒë™' },
        'ë‘ì‚°ë™': { lat: 35.8409, lon: 128.6082, name: 'ëŒ€êµ¬ê´‘ì—­ì‹œ ìˆ˜ì„±êµ¬ ë‘ì‚°ë™' },
        'ì§€ì‚°ë™': { lat: 35.8283, lon: 128.6131, name: 'ëŒ€êµ¬ê´‘ì—­ì‹œ ìˆ˜ì„±êµ¬ ì§€ì‚°ë™' },
        'ë²”ë¬¼ë™': { lat: 35.8366, lon: 128.6950, name: 'ëŒ€êµ¬ê´‘ì—­ì‹œ ìˆ˜ì„±êµ¬ ë²”ë¬¼ë™' },
        'ê³ ì‚°ë™': { lat: 35.8238, lon: 128.7086, name: 'ëŒ€êµ¬ê´‘ì—­ì‹œ ìˆ˜ì„±êµ¬ ê³ ì‚°ë™' },
        'ì‹œì§€ë™': { lat: 35.8319, lon: 128.7222, name: 'ëŒ€êµ¬ê´‘ì—­ì‹œ ìˆ˜ì„±êµ¬ ì‹œì§€ë™' },
        'ì‚¬ì›”ë™': { lat: 35.8447, lon: 128.7358, name: 'ëŒ€êµ¬ê´‘ì—­ì‹œ ìˆ˜ì„±êµ¬ ì‚¬ì›”ë™' },
        'ë§¤í˜¸ë™': { lat: 35.8575, lon: 128.7494, name: 'ëŒ€êµ¬ê´‘ì—­ì‹œ ìˆ˜ì„±êµ¬ ë§¤í˜¸ë™' },
        'ìš±ìˆ˜ë™': { lat: 35.8703, lon: 128.7630, name: 'ëŒ€êµ¬ê´‘ì—­ì‹œ ìˆ˜ì„±êµ¬ ìš±ìˆ˜ë™' },
        
        // ë¶€ì‚° ì£¼ìš” êµ¬
        'í•´ìš´ëŒ€êµ¬': { lat: 35.1633, lon: 129.1636, name: 'ë¶€ì‚°ê´‘ì—­ì‹œ í•´ìš´ëŒ€êµ¬' },
        'ìˆ˜ì˜êµ¬': { lat: 35.1459, lon: 129.1131, name: 'ë¶€ì‚°ê´‘ì—­ì‹œ ìˆ˜ì˜êµ¬' },
        'ë¶€ì‚°ì§„êµ¬': { lat: 35.1630, lon: 129.0532, name: 'ë¶€ì‚°ê´‘ì—­ì‹œ ë¶€ì‚°ì§„êµ¬' },
        'ë™ë˜êµ¬': { lat: 35.1967, lon: 129.0938, name: 'ë¶€ì‚°ê´‘ì—­ì‹œ ë™ë˜êµ¬' },
        'ë‚¨êµ¬': { lat: 35.1365, lon: 129.0849, name: 'ë¶€ì‚°ê´‘ì—­ì‹œ ë‚¨êµ¬' },
        'ë¶êµ¬': { lat: 35.1971, lon: 128.9908, name: 'ë¶€ì‚°ê´‘ì—­ì‹œ ë¶êµ¬' },
        'ê°•ì„œêµ¬': { lat: 35.2123, lon: 128.9804, name: 'ë¶€ì‚°ê´‘ì—­ì‹œ ê°•ì„œêµ¬' },
        'ì‚¬í•˜êµ¬': { lat: 35.1044, lon: 128.9747, name: 'ë¶€ì‚°ê´‘ì—­ì‹œ ì‚¬í•˜êµ¬' },
        'ê¸ˆì •êµ¬': { lat: 35.2429, lon: 129.0922, name: 'ë¶€ì‚°ê´‘ì—­ì‹œ ê¸ˆì •êµ¬' },
        'ì—°ì œêµ¬': { lat: 35.1763, lon: 129.0796, name: 'ë¶€ì‚°ê´‘ì—­ì‹œ ì—°ì œêµ¬' },
        'ì‚¬ìƒêµ¬': { lat: 35.1527, lon: 128.9910, name: 'ë¶€ì‚°ê´‘ì—­ì‹œ ì‚¬ìƒêµ¬' },
        'ê¸°ì¥êµ°': { lat: 35.2445, lon: 129.2222, name: 'ë¶€ì‚°ê´‘ì—­ì‹œ ê¸°ì¥êµ°' },
        'ì¤‘êµ¬': { lat: 35.1063, lon: 129.0323, name: 'ë¶€ì‚°ê´‘ì—­ì‹œ ì¤‘êµ¬' },
        'ì„œêµ¬': { lat: 35.0979, lon: 129.0240, name: 'ë¶€ì‚°ê´‘ì—­ì‹œ ì„œêµ¬' },
        'ë™êµ¬': { lat: 35.1293, lon: 129.0454, name: 'ë¶€ì‚°ê´‘ì—­ì‹œ ë™êµ¬' },
        'ì˜ë„êµ¬': { lat: 35.0911, lon: 129.0679, name: 'ë¶€ì‚°ê´‘ì—­ì‹œ ì˜ë„êµ¬' }
    };
}

/**
 * ì§€ì—­ëª… ë¬¸ìì—´ì„ ì •ê·œí™”í•˜ì—¬ ë¹„êµí•˜ê¸° ì‰½ê²Œ ë§Œë“­ë‹ˆë‹¤.
 * ì´ í•¨ìˆ˜ëŠ” ê³µë°± ë° íŠ¹ìˆ˜ë¬¸ìë§Œ ì œê±°í•˜ê³ , í–‰ì •êµ¬ì—­ ë‹¨ì–´ëŠ” ìœ ì§€í•˜ì—¬ ë” ì •í™•í•œ ë§¤ì¹­ì„ ë•ìŠµë‹ˆë‹¤.
 * @param {string} name - ì •ê·œí™”í•  ì§€ì—­ëª…
 * @returns {string} ì •ê·œí™”ëœ ì§€ì—­ëª…
 */
function normalizeLocationName(name) {
    if (!name) return '';
    // ì†Œë¬¸ì ë³€í™˜, ëª¨ë“  ê³µë°± ì œê±°, í•œê¸€, ì˜ì–´, ìˆ«ì ì™¸ ëª¨ë“  ë¬¸ì ì œê±°
    // 'ì‹œ', 'êµ°', 'êµ¬', 'ì', 'ë©´', 'ë™', 'ë¦¬', 'ë¡œ', 'ê°€' ë“±ì˜ í–‰ì •êµ¬ì—­ ë‹¨ìœ„ëŠ” ì œê±°í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
    return name.toLowerCase()
        .replace(/\s+/g, '') 
        .replace(/[^\wê°€-í£]/g, ''); 
}

/**
 * ì¹´ì¹´ì˜¤ Local APIë¥¼ ì‚¬ìš©í•˜ì—¬ ìœ„ì¹˜ ì •ë³´ë¥¼ ê²€ìƒ‰í•˜ëŠ” í•¨ìˆ˜.
 * í‚¤ì›Œë“œ ê²€ìƒ‰ê³¼ ì£¼ì†Œ ê²€ìƒ‰ì„ ê²°í•©í•˜ê³ , ì ìˆ˜ ê¸°ë°˜ìœ¼ë¡œ ìµœì ì˜ ê²°ê³¼ë¥¼ ì°¾ìŠµë‹ˆë‹¤.
 * @param {string} query - ê²€ìƒ‰í•  ì§€ì—­ëª… ë˜ëŠ” í‚¤ì›Œë“œ
 * @param {string} kakaoApiKey - Kakao REST API í‚¤
 * @returns {Promise<Object|null>} ìµœì ì˜ ë§¤ì¹­ ê²°ê³¼ ê°ì²´ ë˜ëŠ” null
 */
async function searchLocationWithKakao(query, kakaoApiKey) {
    try {
        console.log(`ğŸ” ì¹´ì¹´ì˜¤ API ê²€ìƒ‰ ì‹œì‘: "${query}"`);

        // 1ë‹¨ê³„: í‚¤ì›Œë“œ ê²€ìƒ‰ (ì¥ì†Œ ìš°ì„ ) - ëª¨ë“  ì¹´í…Œê³ ë¦¬
        const keywordResponse = await axios.get('https://dapi.kakao.com/v2/local/search/keyword.json', {
            params: {
                query: query,
                size: 15, // ê²°ê³¼ ê°œìˆ˜ ì¦ê°€
                sort: 'accuracy' // ì •í™•ë„ ìˆœ
            },
            headers: {
                'Authorization': `KakaoAK ${kakaoApiKey}`
            },
            timeout: 5000
        });

        let bestMatch = null;
        const documents = keywordResponse.data.documents || [];

        if (documents.length > 0) {
            // 2ë‹¨ê³„: í‚¤ì›Œë“œ ê²€ìƒ‰ ê²°ê³¼ í•„í„°ë§ ë° ìš°ì„ ìˆœìœ„ ì ìš©
            bestMatch = findBestLocationMatch(query, documents);
        }

        // 3ë‹¨ê³„: í‚¤ì›Œë“œ ê²€ìƒ‰ì—ì„œ ë§Œì¡±ìŠ¤ëŸ¬ìš´ ê²°ê³¼ë¥¼ ì–»ì§€ ëª»í–ˆì„ ê²½ìš° ì£¼ì†Œ ê²€ìƒ‰ ì‹œë„
        // (bestMatchê°€ ì—†ê±°ë‚˜, ìŠ¤ì½”ì–´ê°€ ë‚®ì„ ê²½ìš° (ì˜ˆ: 100ì  ë¯¸ë§Œ) ì£¼ì†Œ ê²€ìƒ‰ìœ¼ë¡œ ë³´ì™„)
        if (!bestMatch || bestMatch.matchScore < 100) { 
            console.log(`ğŸ” í‚¤ì›Œë“œ ê²€ìƒ‰ ê²°ê³¼ ë¶ˆë§Œì¡± (ìŠ¤ì½”ì–´: ${bestMatch ? bestMatch.matchScore : 'ì—†ìŒ'}). ì£¼ì†Œ ê²€ìƒ‰ ì‹œë„...`);
            const addressResponse = await axios.get('https://dapi.kakao.com/v2/local/search/address.json', {
                params: {
                    query: query,
                    analyze_type: 'similar', // ìœ ì‚¬ë„ ë¶„ì„
                    size: 10
                },
                headers: {
                    'Authorization': `KakaoAK ${kakaoApiKey}`
                },
                timeout: 5000
            });

            const addressDocuments = addressResponse.data.documents || [];
            if (addressDocuments.length > 0) {
                const addressBestMatch = findBestAddressMatch(query, addressDocuments);
                // ì£¼ì†Œ ê²€ìƒ‰ ê²°ê³¼ê°€ ë” ì •í™•í•˜ë‹¤ê³  íŒë‹¨ë˜ë©´ êµì²´
                if (addressBestMatch && (!bestMatch || addressBestMatch.matchScore > bestMatch.matchScore)) {
                    bestMatch = addressBestMatch;
                    console.log(`ğŸ‘ ì£¼ì†Œ ê²€ìƒ‰ì—ì„œ ë” ë‚˜ì€ ê²°ê³¼ ë°œê²¬ (ìŠ¤ì½”ì–´: ${addressBestMatch.matchScore}).`);
                }
            }
        }

        return bestMatch;

    } catch (error) {
        console.error('âŒ ì¹´ì¹´ì˜¤ API ê²€ìƒ‰ ì˜¤ë¥˜:', {
            message: error.message,
            response: error.response?.data,
            query: query
        });
        return null;
    }
}

/**
 * ì¹´ì¹´ì˜¤ í‚¤ì›Œë“œ ê²€ìƒ‰ ê²°ê³¼ì—ì„œ ìµœì ì˜ ì¥ì†Œ ë§¤ì¹­ì„ ì°¾ëŠ” ë¡œì§.
 * ë‹¤ì–‘í•œ ê¸°ì¤€ì— ë”°ë¼ ì ìˆ˜ë¥¼ ë¶€ì—¬í•˜ì—¬ ê°€ì¥ ì í•©í•œ ê²°ê³¼ë¥¼ ì„ ë³„í•©ë‹ˆë‹¤.
 * @param {string} query - ì›ë³¸ ê²€ìƒ‰ì–´
 * @param {Array<Object>} documents - Kakao APIì—ì„œ ë°˜í™˜ëœ ì¥ì†Œ ë¬¸ì„œ ë°°ì—´
 * @returns {Object|null} ìµœì ì˜ ë§¤ì¹­ ê²°ê³¼ ê°ì²´ ë˜ëŠ” null
 */
function findBestLocationMatch(query, documents) {
    const originalQueryLower = query.toLowerCase().trim();
    
    // í–‰ì •êµ¬ì—­ ë‹¨ìœ„ í‚¤ì›Œë“œ ì •ì˜
    const adminUnits = ['ì‹œ', 'êµ°', 'êµ¬', 'ì', 'ë©´', 'ë™', 'ë¦¬'];
    const queryEndsWithAdmin = adminUnits.some(unit => originalQueryLower.endsWith(unit));
    
    // ìš°ì„ ìˆœìœ„ ì ìˆ˜ ê³„ì‚°
    const scoredResults = documents.map(doc => {
        let score = 0;
        const placeName = doc.place_name || '';
        const addressName = doc.address_name || '';
        const roadAddressName = doc.road_address_name || '';
        const categoryGroupCode = doc.category_group_code || ''; // AD5: í–‰ì •êµ¬ì—­, POI ì¹´í…Œê³ ë¦¬ ë“±
        const categoryName = doc.category_name || ''; // "ì§€ì—­>í–‰ì •êµ¬ì—­>ë™", "ì§€ì—­>í–‰ì •êµ¬ì—­>ì‹œ" ë“± ìƒì„¸ ì¹´í…Œê³ ë¦¬

        const normalizedPlaceName = normalizeLocationName(placeName);
        const normalizedAddressName = normalizeLocationName(addressName);
        const normalizedRoadAddressName = normalizeLocationName(roadAddressName);
        const normalizedQuery = normalizeLocationName(originalQueryLower);

        // 1. ì›ë³¸ ê²€ìƒ‰ì–´ì™€ ì™„ì „ ì¼ì¹˜í•˜ëŠ” ê²½ìš° (ìµœê³  ì ìˆ˜)
        if (placeName.toLowerCase().trim() === originalQueryLower) {
            score += 1000; // ì¥ì†Œëª… ì™„ì „ ì¼ì¹˜ (ìµœê³  ì ìˆ˜ ëŒ€í­ ìƒí–¥)
            if (categoryGroupCode === 'AD5') score += 500; // í–‰ì •êµ¬ì—­ì´ë©´ ì¶”ê°€ ë³´ë„ˆìŠ¤
        } else if (addressName.toLowerCase().trim() === originalQueryLower) {
            score += 900; // ì£¼ì†Œëª… ì™„ì „ ì¼ì¹˜
        } else if (roadAddressName.toLowerCase().trim() === originalQueryLower) {
            score += 800; // ë„ë¡œëª… ì£¼ì†Œ ì™„ì „ ì¼ì¹˜
        }

        // 2. ê²€ìƒ‰ì–´ê°€ í–‰ì •êµ¬ì—­ ë‹¨ìœ„ë¡œ ëë‚˜ëŠ” ê²½ìš° íŠ¹ë³„ ì²˜ë¦¬
        if (queryEndsWithAdmin) {
            // í–‰ì •êµ¬ì—­ ì¹´í…Œê³ ë¦¬ê°€ ì•„ë‹Œ ê²½ìš° í° í˜ë„í‹°
            if (categoryGroupCode !== 'AD5') {
                score -= 500;
            } else {
                // í–‰ì •êµ¬ì—­ì´ë©´ì„œ ê²€ìƒ‰ì–´ì™€ ì¼ì¹˜í•˜ëŠ” ê²½ìš° ë†’ì€ ì ìˆ˜
                const addressParts = addressName.split(' ');
                const lastPart = addressParts[addressParts.length - 1];
                
                // ì£¼ì†Œì˜ ë§ˆì§€ë§‰ ë¶€ë¶„ì´ ê²€ìƒ‰ì–´ì™€ ì •í™•íˆ ì¼ì¹˜í•˜ëŠ” ê²½ìš°
                if (lastPart === originalQueryLower) {
                    score += 600;
                }
                
                // ì¥ì†Œëª…ì´ ê²€ìƒ‰ì–´ë¡œ ëë‚˜ëŠ” ê²½ìš°
                if (placeName.endsWith(originalQueryLower)) {
                    score += 400;
                }
            }
        }

        // 3. í–‰ì •êµ¬ì—­(AD5)ì— ëŒ€í•œ ë†’ì€ ê°€ì¤‘ì¹˜ ë° ìƒì„¸ ì¹´í…Œê³ ë¦¬ ì ìˆ˜
        if (categoryGroupCode === 'AD5') {
            score += 300; // í–‰ì •êµ¬ì—­ì¸ ê²½ìš° ê¸°ë³¸ ì ìˆ˜
            
            // ì¹´í…Œê³ ë¦¬ëª…ì— ë”°ë¥¸ ì¶”ê°€ ì ìˆ˜
            if (categoryName.includes('í–‰ì •êµ¬ì—­')) {
                if (categoryName.includes('ë™') && originalQueryLower.endsWith('ë™')) score += 200;
                else if (categoryName.includes('êµ¬') && originalQueryLower.endsWith('êµ¬')) score += 200;
                else if (categoryName.includes('ì‹œ') && originalQueryLower.endsWith('ì‹œ')) score += 200;
                else if (categoryName.includes('êµ°') && originalQueryLower.endsWith('êµ°')) score += 200;
                else score += 100;
            }

            // ì •ê·œí™”ëœ ì¿¼ë¦¬ì™€ì˜ ë§¤ì¹­
            if (normalizedPlaceName === normalizedQuery) score += 300;
            else if (normalizedAddressName === normalizedQuery) score += 250;
            else if (normalizedPlaceName.includes(normalizedQuery)) score += 150;
            else if (normalizedAddressName.includes(normalizedQuery)) score += 100;
            
        } else {
            // í–‰ì •êµ¬ì—­ì´ ì•„ë‹Œ ì¼ë°˜ POIëŠ” ê¸°ë³¸ì ìœ¼ë¡œ ë‚®ì€ ì ìˆ˜
            // íŠ¹íˆ ìŒì‹ì , ì¹´í˜ ë“±ì€ ë”ìš± ê°ì 
            const penaltyCategories = ['FD6', 'CE7', 'CS2', 'CT1', 'BK9', 'MT1', 'AT4'];
            if (penaltyCategories.includes(categoryGroupCode)) {
                score -= 300;
            }
            
            // í•˜ì§€ë§Œ ì¥ì†Œëª…ì´ ê²€ìƒ‰ì–´ì™€ ì •í™•íˆ ì¼ì¹˜í•˜ë©´ ì–´ëŠ ì •ë„ ì ìˆ˜ íšŒë³µ
            if (placeName.toLowerCase().trim() === originalQueryLower) {
                score += 200;
            }
        }

        // 4. ë¶€ë¶„ ë§¤ì¹­ ì ìˆ˜ (ì •ê·œí™”ëœ ì´ë¦„ ê¸°ì¤€)
        if (normalizedPlaceName.includes(normalizedQuery)) {
            score += 50;
            // ì¿¼ë¦¬ ê¸¸ì´ ëŒ€ë¹„ ì „ì²´ ì´ë¦„ ê¸¸ì´ê°€ ë„ˆë¬´ ê¸¸ë©´ í˜ë„í‹°
            const lengthRatio = normalizedQuery.length / normalizedPlaceName.length;
            if (lengthRatio < 0.5) score -= 30;
        }
        
        if (normalizedAddressName.includes(normalizedQuery)) {
            score += 40;
            const lengthRatio = normalizedQuery.length / normalizedAddressName.length;
            if (lengthRatio < 0.5) score -= 20;
        }
        
        // 5. ì£¼ì†Œì—ì„œ ê²€ìƒ‰ì–´ê°€ í¬í•¨ëœ ìœ„ì¹˜ì— ë”°ë¥¸ ì ìˆ˜
        const addressParts = addressName.split(' ');
        for (let i = addressParts.length - 1; i >= 0; i--) {
            if (addressParts[i] === originalQueryLower) {
                // ë’¤ìª½ì— ìœ„ì¹˜í• ìˆ˜ë¡ ë†’ì€ ì ìˆ˜ (ë™, êµ¬ ë“±ì€ ë³´í†µ ë’¤ì— ìœ„ì¹˜)
                score += (i + 1) * 20;
                break;
            }
        }

        // 6. ê±°ë¦¬ ê¸°ë°˜ ì ìˆ˜ (ê±°ë¦¬ ì •ë³´ê°€ ìˆëŠ” ê²½ìš°)
        const distance = parseInt(doc.distance) || 0;
        if (distance > 0) {
            if (distance < 1000) score += 20;
            else if (distance < 5000) score += 10;
            else if (distance < 10000) score += 5;
            else score -= 10;
        }

        return {
            ...doc,
            matchScore: Math.max(0, score), // ì ìˆ˜ê°€ ìŒìˆ˜ê°€ ë˜ì§€ ì•Šë„ë¡
            normalizedName: normalizedPlaceName,
            debugInfo: {
                placeName,
                addressName,
                categoryGroupCode,
                categoryName,
                score
            }
        };
    });

    // ì ìˆ˜ ìˆœìœ¼ë¡œ ì •ë ¬ (ë‚´ë¦¼ì°¨ìˆœ)
    scoredResults.sort((a, b) => b.matchScore - a.matchScore);

    // ë””ë²„ê¹… ë¡œê·¸ (ìƒìœ„ 3ê°œ ê²°ê³¼ë§Œ)
    console.log(`ğŸ” '${query}'ì— ëŒ€í•œ ì¹´ì¹´ì˜¤ ê²€ìƒ‰ ê²°ê³¼ (ìƒìœ„ 3ê°œ):`, 
        scoredResults.slice(0, 3).map(r => ({
            name: r.place_name,
            address: r.address_name,
            score: r.matchScore,
            category: r.category_group_code,
            categoryName: r.category_name
        }))
    );

    // ìµœê³  ì ìˆ˜ ê²°ê³¼ ë°˜í™˜
    const bestResult = scoredResults[0];
    
    // ìµœì†Œ ì„ê³„ê°’ ì„¤ì • - ë” ì—„ê²©í•˜ê²Œ ì„¤ì •
    if (bestResult && bestResult.matchScore >= 100) {
        return {
            lat: parseFloat(bestResult.y),
            lon: parseFloat(bestResult.x),
            name: bestResult.address_name || bestResult.place_name, // ì£¼ì†Œëª…ì„ ìš°ì„ ìœ¼ë¡œ
            address: bestResult.address_name,
            roadAddress: bestResult.road_address_name,
            category: bestResult.category_group_name,
            matchScore: bestResult.matchScore,
            source: 'kakao_keyword'
        };
    }

    return null;
}

/**
 * ì¹´ì¹´ì˜¤ ì£¼ì†Œ ê²€ìƒ‰ ê²°ê³¼ì—ì„œ ìµœì ì˜ ì£¼ì†Œ ë§¤ì¹­ì„ ì°¾ëŠ” ë¡œì§.
 * (í‚¤ì›Œë“œ ê²€ìƒ‰ ì‹¤íŒ¨ ì‹œ ë³´ì¡°ì ìœ¼ë¡œ ì‚¬ìš©)
 * @param {string} query - ì›ë³¸ ê²€ìƒ‰ì–´
 * @param {Array<Object>} documents - Kakao APIì—ì„œ ë°˜í™˜ëœ ì£¼ì†Œ ë¬¸ì„œ ë°°ì—´
 * @returns {Object|null} ìµœì ì˜ ë§¤ì¹­ ê²°ê³¼ ê°ì²´ ë˜ëŠ” null
 */
function findBestAddressMatch(query, documents) {
    const originalQueryLower = query.toLowerCase().trim();
    
    // ì£¼ì†Œ ê²€ìƒ‰ ê²°ê³¼ë„ ì ìˆ˜ ê¸°ë°˜ìœ¼ë¡œ ìµœì  ê²°ê³¼ ì„ íƒ
    const scoredResults = documents.map(doc => {
        let score = 0;
        const addressName = doc.address_name || '';
        const roadAddressName = doc.road_address_name || '';
        const buildingName = doc.building_name || '';

        const normalizedAddressName = normalizeLocationName(addressName);
        const normalizedRoadAddressName = normalizeLocationName(roadAddressName);
        const normalizedQuery = normalizeLocationName(originalQueryLower);

        // 1. ì›ë³¸ ê²€ìƒ‰ì–´ì™€ ì™„ì „ ì¼ì¹˜ (ìµœê³  ì ìˆ˜)
        if (addressName.toLowerCase().trim() === originalQueryLower) score += 500;
        else if (roadAddressName.toLowerCase().trim() === originalQueryLower) score += 450;

        // 2. ì£¼ì†Œì˜ ë§ˆì§€ë§‰ ë¶€ë¶„ì´ ê²€ìƒ‰ì–´ì™€ ì¼ì¹˜í•˜ëŠ” ê²½ìš° ë†’ì€ ì ìˆ˜
        const addressParts = addressName.split(' ');
        const lastPart = addressParts[addressParts.length - 1];
        if (lastPart === originalQueryLower) {
            score += 300;
        }

        // 3. ì •ê·œí™”ëœ ì£¼ì†Œëª…ì— ì¿¼ë¦¬ê°€ í¬í•¨ë˜ê±°ë‚˜ ì¿¼ë¦¬ê°€ ì£¼ì†Œëª…ì— í¬í•¨
        if (normalizedAddressName.includes(normalizedQuery)) {
            score += 100;
            // í¬í•¨ ìœ„ì¹˜ì— ë”°ë¥¸ ì¶”ê°€ ì ìˆ˜
            if (normalizedAddressName.endsWith(normalizedQuery)) score += 50;
        }
        if (normalizedRoadAddressName.includes(normalizedQuery)) score += 80;

        // 4. ì£¼ì†Œì˜ ê¹Šì´(depth)ì— ë”°ë¥¸ ê°€ì¤‘ì¹˜
        if (doc.address) {
            if (doc.address.region_3depth_name === originalQueryLower) score += 200;
            if (doc.address.region_2depth_name === originalQueryLower) score += 150;
            if (doc.address.region_1depth_name === originalQueryLower) score += 100;
        }
        
        // 5. ë„ë¡œëª… ì£¼ì†Œ ì •ë³´ê°€ ìˆìœ¼ë©´ ì¶”ê°€ ì ìˆ˜
        if (doc.road_address && doc.road_address.building_name) score += 10;
        
        return {
            ...doc,
            matchScore: Math.max(0, score),
            normalizedName: normalizedAddressName
        };
    });

    // ì ìˆ˜ ìˆœìœ¼ë¡œ ì •ë ¬
    scoredResults.sort((a, b) => b.matchScore - a.matchScore);

    console.log(`ğŸ” '${query}'ì— ëŒ€í•œ ì¹´ì¹´ì˜¤ ì£¼ì†Œ ê²€ìƒ‰ ê²°ê³¼ (ìƒìœ„ 3ê°œ):`, 
        scoredResults.slice(0, 3).map(r => ({
            address: r.address_name,
            score: r.matchScore
        }))
    );

    const bestResult = scoredResults[0];
    // ìµœì†Œ ì„ê³„ê°’ ì„¤ì •
    if (bestResult && bestResult.matchScore >= 100) {
        return {
            lat: parseFloat(bestResult.y),
            lon: parseFloat(bestResult.x),
            name: bestResult.address_name, // ì£¼ì†Œ ê²€ìƒ‰ì€ í•­ìƒ ì£¼ì†Œëª… ì‚¬ìš©
            address: bestResult.address_name,
            roadAddress: bestResult.road_address_name,
            category: 'ì£¼ì†Œ',
            matchScore: bestResult.matchScore,
            source: 'kakao_address'
        };
    }

    return null;
}

/**
 * í†µí•© ìœ„ì¹˜ ê²€ìƒ‰ í•¨ìˆ˜ (ê¸°ì¡´ í•¨ìˆ˜ ëŒ€ì²´)
 * ì‚¬ìš©ì ì…ë ¥ ì§€ì—­ëª…ì„ ìœ„ê²½ë„ ì¢Œí‘œë¡œ ë³€í™˜í•©ë‹ˆë‹¤.
 * ìš°ì„ ìˆœìœ„: 1. í•˜ë“œì½”ë”©ëœ ì •í™• ë§¤ì¹­, 2. ì¹´ì¹´ì˜¤ API ê²€ìƒ‰ (í‚¤ì›Œë“œ & ì£¼ì†Œ), 3. í•˜ë“œì½”ë”©ëœ ë¶€ë¶„ ë§¤ì¹­, 4. ê¸°ë³¸ê°’
 * @param {string} query - ì‚¬ìš©ì ì…ë ¥ ì§€ì—­ëª…
 * @param {string} kakaoApiKey - Kakao REST API í‚¤
 * @returns {Promise<Object>} ë§¤ì¹­ëœ ì§€ì—­ì˜ ì¢Œí‘œ ë° ì´ë¦„ ì •ë³´ {lat, lon, name, source, ...}
 */
async function findLocationCoordinates(query, kakaoApiKey) {
    console.log(`ğŸ” ìœ„ì¹˜ ê²€ìƒ‰ ì‹œì‘: "${query}"`);
    const locations = getLocationCoordinates(); // í•˜ë“œì½”ë”©ëœ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
    const originalQueryLower = query.toLowerCase().trim();

    // 1ìˆœìœ„: í•˜ë“œì½”ë”©ëœ DBì—ì„œ 'ì •í™•í•œ' ì§€ì—­ ë§¤ì¹­ì´ ìˆëŠ”ì§€ ë¨¼ì € í™•ì¸
    // ì›ë³¸ ì¿¼ë¦¬ ë˜ëŠ” ì •ê·œí™”ëœ ì¿¼ë¦¬ ëª¨ë‘ ê³ ë ¤
    const exactFallbackMatchKey = Object.keys(locations).find(key => 
        key.toLowerCase().trim() === originalQueryLower || // key ìì²´ì™€ ì •í™•íˆ ì¼ì¹˜
        normalizeLocationName(key) === normalizeLocationName(originalQueryLower) || // ì •ê·œí™”ëœ keyì™€ ì¿¼ë¦¬ê°€ ì¼ì¹˜
        (locations[key].name && locations[key].name.toLowerCase().trim() === originalQueryLower) || // name í•„ë“œì™€ ì •í™•íˆ ì¼ì¹˜
        (locations[key].name && normalizeLocationName(locations[key].name) === normalizeLocationName(originalQueryLower)) // ì •ê·œí™”ëœ name í•„ë“œì™€ ì¿¼ë¦¬ê°€ ì¼ì¹˜
    );
    
    if (exactFallbackMatchKey) {
        console.log(`âœ… í•˜ë“œì½”ë”© DB ì •í™• ë§¤ì¹­: '${query}' -> '${locations[exactFallbackMatchKey].name}'`);
        return {
            ...locations[exactFallbackMatchKey],
            source: 'hardcoded_exact'
        };
    }

    // 2ìˆœìœ„: ì¹´ì¹´ì˜¤ API ê²€ìƒ‰ ì‹œë„
    if (kakaoApiKey) {
        const kakaoResult = await searchLocationWithKakao(query, kakaoApiKey);
        if (kakaoResult) {
            console.log(`âœ… ì¹´ì¹´ì˜¤ API ë§¤ì¹­ ì„±ê³µ: '${query}' -> '${kakaoResult.name}' (ì ìˆ˜: ${kakaoResult.matchScore})`);
            return kakaoResult;
        }
    } else {
        console.warn('âš ï¸ KAKAO_REST_API_KEY í™˜ê²½ ë³€ìˆ˜ê°€ ì„¤ì •ë˜ì§€ ì•Šì•„ Kakao Geocoding APIë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. í•˜ë“œì½”ë”©ëœ í´ë°± ì‚¬ìš© ì‹œë„.');
    }
    
    // 3ìˆœìœ„: í•˜ë“œì½”ë”©ëœ DBì—ì„œ 'ë¶€ë¶„ ë§¤ì¹­' ì‹œë„ - ë” ì •í™•í•œ ë§¤ì¹­ì„ ìœ„í•´ ê°œì„ 
    const normalizedQuery = normalizeLocationName(originalQueryLower);
    let bestPartialMatch = null;
    let bestPartialScore = 0;

    for (const [key, coords] of Object.entries(locations)) {
        const normalizedKey = normalizeLocationName(key);
        const normalizedFullName = normalizeLocationName(coords.name || '');
        let score = 0;
        
        // ì •í™•í•œ ë§¤ì¹­ì— ê°€ê¹Œìš¸ìˆ˜ë¡ ë†’ì€ ì ìˆ˜
        if (normalizedKey === normalizedQuery) {
            score = 100;
        } else if (normalizedFullName === normalizedQuery) {
            score = 95;
        } else if (normalizedKey.endsWith(normalizedQuery) || normalizedFullName.endsWith(normalizedQuery)) {
            score = 80;
        } else if (normalizedKey.includes(normalizedQuery) || normalizedFullName.includes(normalizedQuery)) {
            score = 60;
        } else if (normalizedQuery.includes(normalizedKey) || normalizedQuery.includes(normalizedFullName)) {
            score = 40;
        }
        
        // ê¸¸ì´ê°€ ë¹„ìŠ·í• ìˆ˜ë¡ ì¶”ê°€ ì ìˆ˜
        if (score > 0) {
            const lengthDiff = Math.abs(normalizedQuery.length - normalizedKey.length);
            score -= lengthDiff * 2;
        }
        
        if (score > bestPartialScore) {
            bestPartialScore = score;
            bestPartialMatch = coords;
        }
    }
    
    if (bestPartialMatch && bestPartialScore >= 40) {
        console.log(`âš ï¸ í•˜ë“œì½”ë”© DB ë¶€ë¶„ ë§¤ì¹­: '${query}' -> '${bestPartialMatch.name}' (ì ìˆ˜: ${bestPartialScore})`);
        return {
            ...bestPartialMatch,
            source: 'hardcoded_partial',
            matchScore: bestPartialScore
        };
    }
    
    // 4ìˆœìœ„: ëª¨ë“  ì‹œë„ ì‹¤íŒ¨ ì‹œ ê¸°ë³¸ ì§€ì—­ ë°˜í™˜
    console.warn(`âŒ "${query}"ì— ëŒ€í•œ ìœ„ì¹˜ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ê¸°ë³¸ê°’ "${DEFAULT_REGION}" ì‚¬ìš©.`);
    return {
        ...locations[DEFAULT_REGION],
        source: 'default',
        originalQuery: query // ì›ë˜ ê²€ìƒ‰ì–´ ë³´ì¡´
    };
}
/**
 * ê¸°ìƒì²­ API ì‘ë‹µ ë°ì´í„°ë¥¼ ê°€ê³µí•˜ì—¬ 3ì¼ê°„ì˜ ì™„ì „í•œ ë‚ ì”¨ ì •ë³´ ë°˜í™˜í•©ë‹ˆë‹¤.
 * @param {Array} items - ê¸°ìƒì²­ APIì—ì„œ ë°˜í™˜ëœ ë‚ ì”¨ ë°ì´í„° í•­ëª© ë°°ì—´
 * @param {Date} kst - í•œêµ­ í‘œì¤€ì‹œ Date ê°ì²´
 * @returns {Array} ê°€ê³µëœ 3ì¼ê°„ì˜ ë‚ ì”¨ ë°ì´í„° ë°°ì—´
 */
function processCompleteWeatherData(items, kst) {
    const forecasts = {};

    // ì˜¤ëŠ˜, ë‚´ì¼, ëª¨ë ˆ ë‚ ì§œ ê³„ì‚°
    const today = kst.toISOString().slice(0, 10).replace(/-/g, '');
    const tomorrow = new Date(kst.getTime() + 24 * 60 * 60 * 1000).toISOString().slice(0, 10).replace(/-/g, '');
    const dayAfter = new Date(kst.getTime() + 48 * 60 * 60 * 1000).toISOString().slice(0, 10).replace(/-/g, '');

    // ëª¨ë“  ê¸°ìƒ ë°ì´í„° ë¶„ë¥˜
    items.forEach(item => {
        const date = item.fcstDate;
        const time = item.fcstTime;
        const category = item.category;
        const value = item.fcstValue;

        if (!forecasts[date]) {
            forecasts[date] = {
                times: {},
                dailyData: {
                    temperatureMin: null,
                    temperatureMax: null,
                    precipitationProbabilityMax: 0
                }
            };
        }

        if (!forecasts[date].times[time]) {
            forecasts[date].times[time] = {};
        }

        forecasts[date].times[time][category] = value;

        // ì¼ë³„ ìµœì €/ìµœê³  ê¸°ì˜¨ ë° ìµœëŒ€ ê°•ìˆ˜í™•ë¥  ì¶”ì¶œ (TMN, TMXëŠ” íŠ¹ì • ì‹œê°ì—ë§Œ ì œê³µë¨)
        if (category === 'TMN' && value) {
            const tmnValue = parseFloat(value);
            // TMNì€ ë³´í†µ ì²«ë‚ ì˜ 0600ì—ë§Œ ì¡´ì¬
            if (forecasts[date].dailyData.temperatureMin === null || tmnValue < forecasts[date].dailyData.temperatureMin) {
                forecasts[date].dailyData.temperatureMin = tmnValue;
            }
        }
        if (category === 'TMX' && value) {
            const tmxValue = parseFloat(value);
            // TMXëŠ” ë³´í†µ ì²«ë‚ ì˜ 1500ì—ë§Œ ì¡´ì¬
            if (forecasts[date].dailyData.temperatureMax === null || tmxValue > forecasts[date].dailyData.temperatureMax) {
                forecasts[date].dailyData.temperatureMax = tmxValue;
            }
        }
        if (category === 'POP' && value) {
            const pop = parseFloat(value);
            if (pop > forecasts[date].dailyData.precipitationProbabilityMax) {
                forecasts[date].dailyData.precipitationProbabilityMax = pop;
            }
        }
    });

    // 3ì¼ê°„ ì™„ì „í•œ ë‚ ì”¨ ë°ì´í„° ìƒì„±
    const result = [];
    [today, tomorrow, dayAfter].forEach((date, index) => {
        if (forecasts[date]) {
            const dayData = extractCompleteWeatherData(forecasts[date], date);
            dayData.dayLabel = index === 0 ? 'ì˜¤ëŠ˜' : index === 1 ? 'ë‚´ì¼' : 'ëª¨ë ˆ';
            dayData.dayIndex = index;
            result.push(dayData);
        }
    });

    // TMN/TMX ê°’ì´ ì—†ëŠ” ê²½ìš° ì‹œê°„ë³„ ë°ì´í„°ì—ì„œ ìµœì €/ìµœê³  ì¶”ì¶œ (ëª¨ë“  ë‚ ì§œì— ëŒ€í•´)
    result.forEach(day => {
        if (day.temperatureMin === null || day.temperatureMax === null) {
            let minTemp = Infinity;
            let maxTemp = -Infinity;
            let foundTemp = false;

            day.hourlyData.forEach(hourly => {
                if (hourly.temperature !== null) {
                    minTemp = Math.min(minTemp, hourly.temperature);
                    maxTemp = Math.max(maxTemp, hourly.temperature);
                    foundTemp = true;
                }
            });

            if (foundTemp) {
                if (day.temperatureMin === null) day.temperatureMin = minTemp;
                if (day.temperatureMax === null) day.temperatureMax = maxTemp;
            }
        }
    });

    return result;
}

/**
 * ì¼ë³„ ë‚ ì”¨ ë°ì´í„°ì—ì„œ í•„ìš”í•œ ì •ë³´ ì¶”ì¶œ ë° ê°€ê³µ
 * @param {Object} dayForecast - íŠ¹ì • ì¼ìì˜ ë‚ ì”¨ ì˜ˆì¸¡ ë°ì´í„°
 * @param {string} date - ë‚ ì§œ (YYYYMMDD í˜•ì‹)
 * @returns {Object} ê°€ê³µëœ ì¼ë³„ ë‚ ì”¨ ë°ì´í„°
 */
function extractCompleteWeatherData(dayForecast, date) {
    const times = dayForecast.times;
    const dailyData = dayForecast.dailyData;

    // ëŒ€í‘œ ì‹œê°„ ì„ íƒ (14ì‹œ ìš°ì„ , ì—†ìœ¼ë©´ 12-15ì‹œ ì‚¬ì´, ê·¸ ë‹¤ìŒ ê°€ì¥ ê°€ê¹Œìš´ ì‹œê°„)
    const timeKeys = Object.keys(times).sort();
    let representativeTime = timeKeys.find(t => t === '1400') ||
        timeKeys.find(t => t >= '1200' && t <= '1500') ||
        timeKeys[Math.floor(timeKeys.length / 2)];

    if (!representativeTime && timeKeys.length > 0) {
        representativeTime = timeKeys[0];
    }

    const data = representativeTime ? times[representativeTime] : {};

    // ì™„ì „í•œ ë‚ ì”¨ ì •ë³´ ìƒì„±
    return {
        date: date,
        dateFormatted: `${date.slice(0, 4)}-${date.slice(4, 6)}-${date.slice(6, 8)}`,
        representativeTime: representativeTime,

        // ê¸°ì˜¨ ì •ë³´ (ì™„ì „)
        temperature: data.TMP ? Math.round(parseFloat(data.TMP)) : null,
        // TMN, TMXëŠ” ì¼ë³„ ë°ì´í„°ì—ì„œ ê°€ì ¸ì˜´ (ë³´í†µ ìƒˆë²½/ì˜¤í›„ ê°’ìœ¼ë¡œë§Œ ì¡´ì¬)
        temperatureMin: dailyData.temperatureMin !== null ? Math.round(dailyData.temperatureMin) : null,
        temperatureMax: dailyData.temperatureMax !== null ? Math.round(dailyData.temperatureMax) : null,
        temperatureUnit: 'Â°C',
        temperatureDescription: getTemperatureDescription(data.TMP),

        // í•˜ëŠ˜ ìƒíƒœ (ì™„ì „)
        sky: getSkyDescription(data.SKY),
        skyCode: data.SKY,
        skyDescription: WEATHER_CODES.SKY[data.SKY] || 'ì •ë³´ì—†ìŒ',

        // ê°•ìˆ˜ ì •ë³´ (ì™„ì „)
        precipitation: getPrecipitationDescription(data.PTY),
        precipitationCode: data.PTY,
        precipitationDescription: WEATHER_CODES.PTY[data.PTY] || 'ì—†ìŒ',
        precipitationProbability: data.POP ? parseInt(data.POP) : 0,
        precipitationProbabilityMax: Math.round(dailyData.precipitationProbabilityMax),
        precipitationProbabilityDescription: WEATHER_CODES.POP[data.POP] || '0% (ê°•ìˆ˜ ì—†ìŒ)',
        precipitationAmount: processPrecipitationAmount(data.PCP),
        precipitationAmountDescription: WEATHER_CODES.PCP[data.PCP] || '0mm',

        // ì ì„¤ ì •ë³´ (ì™„ì „)
        snowAmount: processSnowAmount(data.SNO),
        snowAmountDescription: WEATHER_CODES.SNO[data.SNO] || '0cm',

        // ìŠµë„ ì •ë³´ (ì™„ì „)
        humidity: data.REH ? parseInt(data.REH) : null,
        humidityUnit: '%',
        humidityDescription: getHumidityDescription(data.REH),

        // í’ì†/í’í–¥ ì •ë³´ (ì™„ì „)
        windSpeed: data.WSD ? parseFloat(data.WSD).toFixed(1) : null,
        windSpeedUnit: 'm/s',
        windSpeedDescription: getWindSpeedDescription(data.WSD),
        windDirection: getWindDirectionFromDegree(data.VEC),
        windDirectionDegree: data.VEC ? parseFloat(data.VEC) : null,
        windDirectionDescription: data.VEC ? `${getWindDirectionFromDegree(data.VEC)} (${data.VEC}Â°)` : 'ì •ë³´ì—†ìŒ',

        // íŒŒê³  ì •ë³´ (ì™„ì „)
        waveHeight: data.WAV || null,
        waveHeightDescription: WEATHER_CODES.WAV[data.WAV] || 'ì •ë³´ì—†ìŒ',

        // ì¶”ê°€ ìƒì„¸ ì •ë³´
        uvIndex: data.UVI || null,
        visibility: data.VIS || null,

        // ì¢…í•© ë‚ ì”¨ ìƒíƒœ
        weatherStatus: getOverallWeatherStatus(data),
        weatherAdvice: getWeatherAdvice(data),

        // ì‹œê°„ë³„ ìƒì„¸ ë°ì´í„° (ì„ íƒì ìœ¼ë¡œ í¬í•¨)
        hourlyData: Object.keys(times).map(time => ({
            time: time,
            timeFormatted: `${time.slice(0, 2)}:${time.slice(2, 4)}`,
            temperature: times[time].TMP ? Math.round(parseFloat(times[time].TMP)) : null,
            sky: WEATHER_CODES.SKY[times[time].SKY] || 'ì •ë³´ì—†ìŒ',
            precipitation: WEATHER_CODES.PTY[times[time].PTY] || 'ì—†ìŒ',
            precipitationProbability: times[time].POP ? parseInt(times[time].POP) : 0,
            humidity: times[time].REH ? parseInt(times[time].REH) : null,
            windSpeed: times[time].WSD ? parseFloat(times[time].WSD).toFixed(1) : null
        })).sort((a, b) => a.time.localeCompare(b.time))
    };
}

// **ê¸°ì˜¨ì— ë”°ë¥¸ ì„¤ëª… ë°˜í™˜**
function getTemperatureDescription(temp) {
    if (temp === null || temp === undefined) return 'ì •ë³´ì—†ìŒ';
    const t = parseFloat(temp);
    if (t <= -20) return 'í˜¹í•œ (ë§¤ìš° ì¶”ì›€)';
    if (t <= -10) return 'í•œíŒŒ (ë§¤ìš° ì¶”ì›€)';
    if (t <= 0) return 'ì¶”ìœ„ (ì¶”ì›€)';
    if (t <= 9) return 'ìŒ€ìŒ€ (ìŒ€ìŒ€í•¨)';
    if (t <= 15) return 'ì„œëŠ˜ (ì„œëŠ˜í•¨)';
    if (t <= 20) return 'ì„ ì„  (ì„ ì„ í•¨)';
    if (t <= 25) return 'ì ë‹¹ (ì¾Œì í•¨)';
    if (t <= 28) return 'ë”°ëœ» (ë”°ëœ»í•¨)';
    if (t <= 32) return 'ë”ìœ„ (ë”ì›€)';
    if (t <= 35) return 'í­ì—¼ (ë§¤ìš° ë”ì›€)';
    return 'ê·¹ì‹¬í•œí­ì—¼ (ìœ„í—˜)';
}

// **í•˜ëŠ˜ ìƒíƒœ ì½”ë“œì— ë”°ë¥¸ ì„¤ëª… ë°˜í™˜**
function getSkyDescription(code) {
    return WEATHER_CODES.SKY[code] || 'ì •ë³´ì—†ìŒ';
}

// **ê°•ìˆ˜ í˜•íƒœ ì½”ë“œì— ë”°ë¥¸ ì„¤ëª… ë°˜í™˜**
function getPrecipitationDescription(code) {
    return WEATHER_CODES.PTY[code] || 'ì—†ìŒ';
}

// **ê°•ìˆ˜ëŸ‰ ê°’ ì²˜ë¦¬ ë° ì„¤ëª… ë°˜í™˜**
function processPrecipitationAmount(pcp) {
    if (!pcp || pcp === 'ê°•ìˆ˜ì—†ìŒ' || pcp === '0') return '0mm';
    if (pcp === '1mm ë¯¸ë§Œ') return '1mm ë¯¸ë§Œ';
    if (pcp.includes('mm')) return pcp;
    return `${pcp}mm`;
}

// **ì ì„¤ëŸ‰ ê°’ ì²˜ë¦¬ ë° ì„¤ëª… ë°˜í™˜**
function processSnowAmount(sno) {
    if (!sno || sno === 'ì ì„¤ì—†ìŒ' || sno === '0') return '0cm';
    if (sno === '1cm ë¯¸ë§Œ') return '1cm ë¯¸ë§Œ';
    if (sno.includes('cm')) return sno;
    return `${sno}cm`;
}

// **ìŠµë„ì— ë”°ë¥¸ ì„¤ëª… ë°˜í™˜**
function getHumidityDescription(humidity) {
    if (humidity === null || humidity === undefined) return 'ì •ë³´ì—†ìŒ';
    const h = parseInt(humidity);
    if (h <= 20) return 'ë§¤ìš° ê±´ì¡°';
    if (h <= 40) return 'ê±´ì¡°';
    if (h <= 60) return 'ë³´í†µ';
    if (h <= 80) return 'ìŠµí•¨';
    return 'ë§¤ìš° ìŠµí•¨';
}

// **í’ì†ì— ë”°ë¥¸ ì„¤ëª… ë°˜í™˜**
function getWindSpeedDescription(windSpeed) {
    if (windSpeed === null || windSpeed === undefined) return 'ì •ë³´ì—†ìŒ';
    const ws = parseFloat(windSpeed);
    if (ws < 1) return '0-1m/s (ê³ ìš”)';
    if (ws < 2) return '1-2m/s (ì‹¤ë°”ëŒ)';
    if (ws < 3) return '2-3m/s (ë‚¨ì‹¤ë°”ëŒ)';
    if (ws < 4) return '3-4m/s (ì‚°ë“¤ë°”ëŒ)';
    if (ws < 5) return '4-5m/s (ê±´ë“¤ë°”ëŒ)';
    if (ws < 7) return '5-7m/s (ì„ ì„ í•œë°”ëŒ)';
    if (ws < 9) return '7-9m/s (ì‹œì›í•œë°”ëŒ)';
    if (ws < 11) return '9-11m/s (ì„¼ë°”ëŒ)';
    if (ws < 14) return '11-14m/s (ê°•í•œë°”ëŒ)';
    if (ws < 17) return '14-17m/s (ë§¤ìš°ê°•í•œë°”ëŒ)';
    if (ws < 21) return '17-21m/s (í­í’)';
    if (ws < 25) return '21-25m/s (ê°•í•œí­í’)';
    return '25m/s ì´ìƒ (ë§¤ìš°ê°•í•œí­í’)';
}

// **í’í–¥ ê°ë„ì— ë”°ë¥¸ 16ë°©ìœ„ ì„¤ëª… ë°˜í™˜**
function getWindDirectionFromDegree(degree) {
    if (degree === null || degree === undefined) return 'ì •ë³´ì—†ìŒ';

    const deg = parseFloat(degree);
    const normalizedDeg = ((deg % 360) + 360) % 360;

    const directions = [
        'ë¶', 'ë¶ë¶ë™', 'ë¶ë™', 'ë™ë¶ë™', 'ë™', 'ë™ë‚¨ë™', 'ë‚¨ë™', 'ë‚¨ë‚¨ë™',
        'ë‚¨', 'ë‚¨ë‚¨ì„œ', 'ë‚¨ì„œ', 'ì„œë‚¨ì„œ', 'ì„œ', 'ì„œë¶ì„œ', 'ë¶ì„œ', 'ë¶ë¶ì„œ'
    ];

    const index = Math.round(normalizedDeg / 22.5) % 16;
    return directions[index];
}

// **ì£¼ìš” ë‚ ì”¨ ìš”ì†Œ ê¸°ë°˜ ì¢…í•© ë‚ ì”¨ ìƒíƒœ ë°˜í™˜**
function getOverallWeatherStatus(data) {
    const temp = data.TMP ? parseFloat(data.TMP) : null;
    const sky = data.SKY;
    const pty = data.PTY;
    const pop = data.POP ? parseInt(data.POP) : 0;

    if (pty && pty !== '0') {
        const precipType = WEATHER_CODES.PTY[pty] || 'ê°•ìˆ˜';
        if (pop >= 80) return `${precipType} í™•ì‹¤`;
        if (pop >= 60) return `${precipType} ê°€ëŠ¥ì„± ë†’ìŒ`;
        return `${precipType} ê°€ëŠ¥ì„± ìˆìŒ`;
    }

    if (pop >= 60) {
        return 'ê°•ìˆ˜ ê°€ëŠ¥ì„± ë†’ìŒ';
    }

    const skyDesc = WEATHER_CODES.SKY[sky] || 'ì •ë³´ì—†ìŒ';

    if (temp !== null) {
        if (temp >= 33) return `${skyDesc}, í­ì—¼ ì£¼ì˜`;
        if (temp >= 28) return `${skyDesc}, ë”ì›€`;
        if (temp >= 21) return `${skyDesc}, ì¾Œì `;
        if (temp >= 10) return `${skyDesc}, ì„ ì„ `;
        if (temp >= 0) return `${skyDesc}, ìŒ€ìŒ€`;
        return `${skyDesc}, ì¶”ì›€`;
    }

    return skyDesc;
}

// **í˜„ì¬ ë‚ ì”¨ ë°ì´í„° ê¸°ë°˜ ë§ì¶¤í˜• ì¡°ì–¸ ë°˜í™˜**
function getWeatherAdvice(data) {
    const temp = data.TMP ? parseFloat(data.TMP) : null;
    const pty = data.PTY;
    const pop = data.POP ? parseInt(data.POP) : 0;
    const wsd = data.WSD ? parseFloat(data.WSD) : 0;

    const advice = [];

    // ê¸°ì˜¨ ê´€ë ¨ ì¡°ì–¸
    if (temp !== null) {
        if (temp >= 35) advice.push('ğŸŒ¡ï¸ í­ì—¼ ê²½ë³´! ì•¼ì™¸í™œë™ ìì œí•˜ì„¸ìš”');
        else if (temp >= 33) advice.push('ğŸŒ¡ï¸ í­ì—¼ ì£¼ì˜! ì¶©ë¶„í•œ ìˆ˜ë¶„ ì„­ì·¨í•˜ì„¸ìš”');
        else if (temp >= 28) advice.push('â˜€ï¸ ë”ìš´ ë‚ ì”¨, ì‹œì›í•œ ë³µì¥ ì¶”ì²œ');
        else if (temp <= -10) advice.push('ğŸ§Š í•œíŒŒ ì£¼ì˜! ë°©í•œìš©í’ˆ í•„ìˆ˜');
        else if (temp <= 0) advice.push('â„ï¸ ì¶”ìš´ ë‚ ì”¨, ë”°ëœ»í•œ ë³µì¥ í•„ìš”');
        else if (temp <= 10) advice.push('ğŸ§¥ ìŒ€ìŒ€í•œ ë‚ ì”¨, ì™¸íˆ¬ ì¤€ë¹„í•˜ì„¸ìš”');
    }

    // ê°•ìˆ˜ ê´€ë ¨ ì¡°ì–¸
    if (pty && pty !== '0') {
        const precipType = WEATHER_CODES.PTY[pty];
        if (precipType && precipType.includes('ë¹„')) advice.push('â˜” ìš°ì‚° ë˜ëŠ” ìš°ë¹„ ì¤€ë¹„í•˜ì„¸ìš”');
        if (precipType && precipType.includes('ëˆˆ')) advice.push('â›„ ëˆˆ ì˜ˆë³´, ë¯¸ë„ëŸ¼ ì£¼ì˜í•˜ì„¸ìš”');
        if (precipType && precipType.includes('í­ìš°')) advice.push('ğŸš¨ í­ìš° ì£¼ì˜! ì €ì§€ëŒ€ ì¹¨ìˆ˜ ì¡°ì‹¬');
    } else if (pop >= 60) {
        advice.push('ğŸŒ§ï¸ ê°•ìˆ˜ ê°€ëŠ¥ì„± ë†’ìŒ, ìš°ì‚° ì¤€ë¹„ ê¶Œì¥');
    } else if (pop >= 30) {
        advice.push('â˜ï¸ êµ¬ë¦„ ë§ìŒ, ìš°ì‚° íœ´ëŒ€ ê¶Œì¥');
    }

    // ë°”ëŒ ê´€ë ¨ ì¡°ì–¸
    if (wsd >= 14) advice.push('ğŸ’¨ ê°•í’ ì£¼ì˜! ì•¼ì™¸í™œë™ ì¡°ì‹¬í•˜ì„¸ìš”');
    else if (wsd >= 10) advice.push('ğŸŒ¬ï¸ ë°”ëŒì´ ê°•í•´ìš”, ëª¨ìë‚˜ ê°€ë²¼ìš´ ë¬¼ê±´ ì£¼ì˜');

    return advice.length > 0 ? advice.join(' | ') : 'ì¾Œì í•œ ë‚ ì”¨ì…ë‹ˆë‹¤';
}

/**
 * API í‚¤ê°€ ì—†ê±°ë‚˜ ì˜¤ë¥˜ ë°œìƒ ì‹œ ì™„ì „í•œ ìƒ˜í”Œ ë°ì´í„° ìƒì„±
 * @param {string} region - ìš”ì²­ëœ ì§€ì—­ëª…
 * @param {string} [errorMessage=null] - ë°œìƒí•œ ì˜¤ë¥˜ ë©”ì‹œì§€ (ì„ íƒ ì‚¬í•­)
 * @returns {Array} ìƒ˜í”Œ ë‚ ì”¨ ë°ì´í„° ë°°ì—´
 */
function generateCompleteSampleData(region, errorMessage = null) {
    const today = new Date();
    const kst = new Date(today.getTime() + 9 * 60 * 60 * 1000);

    const dates = [];
    for (let i = 0; i < 3; i++) {
        const date = new Date(kst.getTime() + i * 24 * 60 * 60 * 1000);
        dates.push(date);
    }

    const baseMessage = errorMessage ? `âš ï¸ ì˜¤ë¥˜: ${errorMessage}` : 'âš ï¸ API í‚¤ ì„¤ì • ë˜ëŠ” ë„¤íŠ¸ì›Œí¬ ë¬¸ì œ - ìƒ˜í”Œ ë°ì´í„°';
    const sampleTemps = [20, 22, 21];
    const sampleSkies = ['1', '3', '4'];
    const samplePrecips = ['0', '0', '1'];

    // ìƒ˜í”Œ ë°ì´í„°ì˜ locationInfoì— ëŒ€í•œ fullNameì„ 'ì„œìš¸íŠ¹ë³„ì‹œ'ë¡œ ì„¤ì •
    const defaultLocationFullName = 'ì„œìš¸íŠ¹ë³„ì‹œ';

    return dates.map((date, index) => ({
        date: date.toISOString().slice(0, 10).replace(/-/g, ''),
        dateFormatted: date.toISOString().slice(0, 10),
        dayLabel: index === 0 ? 'ì˜¤ëŠ˜' : index === 1 ? 'ë‚´ì¼' : 'ëª¨ë ˆ',
        dayIndex: index,
        representativeTime: '1400',

        // ê¸°ì˜¨ ì •ë³´
        temperature: errorMessage ? null : sampleTemps[index],
        temperatureMin: errorMessage ? null : sampleTemps[index] - 5,
        temperatureMax: errorMessage ? null : sampleTemps[index] + 5,
        temperatureUnit: 'Â°C',
        temperatureDescription: errorMessage ? 'ì •ë³´ì—†ìŒ' : getTemperatureDescription(sampleTemps[index]),

        // í•˜ëŠ˜ ìƒíƒœ
        sky: errorMessage ? 'ì •ë³´ì—†ìŒ' : WEATHER_CODES.SKY[sampleSkies[index]],
        skyCode: errorMessage ? null : sampleSkies[index],
        skyDescription: errorMessage ? 'ì •ë³´ì—†ìŒ' : WEATHER_CODES.SKY[sampleSkies[index]],

        // ê°•ìˆ˜ ì •ë³´
        precipitation: errorMessage ? 'ì •ë³´ì—†ìŒ' : WEATHER_CODES.PTY[samplePrecips[index]],
        precipitationCode: errorMessage ? null : samplePrecips[index],
        precipitationDescription: errorMessage ? 'ì •ë³´ì—†ìŒ' : WEATHER_CODES.PTY[samplePrecips[index]],
        precipitationProbability: errorMessage ? null : [10, 30, 60][index],
        precipitationProbabilityMax: errorMessage ? null : [10, 30, 60][index],
        precipitationProbabilityDescription: WEATHER_CODES.POP[[10, 30, 60][index]],
        precipitationAmount: errorMessage ? 'ì •ë³´ì—†ìŒ' : index === 2 ? '5mm' : '0mm',
        precipitationAmountDescription: errorMessage ? 'ì •ë³´ì—†ìŒ' : index === 2 ? '5mm (ë³´í†µ ë¹„)' : '0mm',

        // ì ì„¤ ì •ë³´
        snowAmount: '0cm',
        snowAmountDescription: '0cm',

        // ìŠµë„ ì •ë³´
        humidity: errorMessage ? null : [60, 70, 80][index],
        humidityUnit: '%',
        humidityDescription: errorMessage ? 'ì •ë³´ì—†ìŒ' : getHumidityDescription([60, 70, 80][index]),

        // í’ì†/í’í–¥ ì •ë³´
        windSpeed: errorMessage ? null : [2.5, 3.0, 3.5][index].toFixed(1),
        windSpeedUnit: 'm/s',
        windSpeedDescription: errorMessage ? 'ì •ë³´ì—†ìŒ' : getWindSpeedDescription([2.5, 3.0, 3.5][index]),
        windDirection: errorMessage ? 'ì •ë³´ì—†ìŒ' : ['ë¶ë™', 'ë‚¨', 'ì„œ'][index],
        windDirectionDegree: errorMessage ? null : [45, 180, 270][index],
        windDirectionDescription: errorMessage ? 'ì •ë³´ì—†ìŒ' : `${['ë¶ë™', 'ë‚¨', 'ì„œ'][index]} (${[45, 180, 270][index]}Â°)`,

        // íŒŒê³  ì •ë³´
        waveHeight: null,
        waveHeightDescription: 'ì •ë³´ì—†ìŒ',

        // ì¶”ê°€ ì •ë³´
        uvIndex: null,
        visibility: null,

        // ì¢…í•© ìƒíƒœ
        weatherStatus: errorMessage ? 'ì •ë³´ì—†ìŒ' : getOverallWeatherStatus({
            TMP: sampleTemps[index],
            SKY: sampleSkies[index],
            PTY: samplePrecips[index],
            POP: [10, 30, 60][index]
        }),
        weatherAdvice: errorMessage ? 'ì •ë³´ë¥¼ í™•ì¸í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤' : getWeatherAdvice({
            TMP: sampleTemps[index],
            PTY: samplePrecips[index],
            POP: [10, 30, 60][index],
            WSD: [2.5, 3.0, 3.5][index]
        }),

        // ì‹œê°„ë³„ ë°ì´í„° (ìƒ˜í”Œ)
        hourlyData: errorMessage ? [] : [
            {
                time: '0600',
                timeFormatted: '06:00',
                temperature: sampleTemps[index] - 3,
                sky: WEATHER_CODES.SKY[sampleSkies[index]],
                precipitation: WEATHER_CODES.PTY[samplePrecips[index]],
                precipitationProbability: [10, 30, 60][index],
                humidity: [60, 70, 80][index],
                windSpeed: [2.5, 3.0, 3.5][index].toFixed(1)
            },
            {
                time: '1200',
                timeFormatted: '12:00',
                temperature: sampleTemps[index],
                sky: WEATHER_CODES.SKY[sampleSkies[index]],
                precipitation: WEATHER_CODES.PTY[samplePrecips[index]],
                precipitationProbability: [10, 30, 60][index],
                humidity: [60, 70, 80][index],
                windSpeed: [2.5, 3.0, 3.5][index].toFixed(1)
            },
            {
                time: '1800',
                timeFormatted: '18:00',
                temperature: sampleTemps[index] - 2,
                sky: WEATHER_CODES.SKY[sampleSkies[index]],
                precipitation: WEATHER_CODES.PTY[samplePrecips[index]],
                precipitationProbability: [10, 30, 60][index],
                humidity: [60, 70, 80][index],
                windSpeed: [2.5, 3.0, 3.5][index].toFixed(1)
            }
        ],

        message: `${baseMessage} (${['ì˜¤ëŠ˜', 'ë‚´ì¼', 'ëª¨ë ˆ'][index]})`,
        timestamp: new Date().toISOString(),
        region: region
    }));
}

/**
 * ë©”ì¸ ì„œë²„ë¦¬ìŠ¤ í•¸ë“¤ëŸ¬ í•¨ìˆ˜
 * @param {Object} req - ìš”ì²­ ê°ì²´
 * @param {Object} res - ì‘ë‹µ ê°ì²´
 */
module.exports = async function handler(req, res) {
    // CORS ì„¤ì •
    res.setHeader('Access-Control-Allow-Origin', '*');
    res.setHeader('Access-Control-Allow-Methods', 'GET, OPTIONS');
    res.setHeader('Access-Control-Allow-Headers', 'Content-Type');
    res.setHeader('Cache-Control', 's-maxage=1800, stale-while-revalidate=3600');

    if (req.method === 'OPTIONS') {
        return res.status(200).end();
    }

    if (req.method !== 'GET') {
        return res.status(405).json({
            success: false,
            error: 'Method not allowed',
            message: 'GET ìš”ì²­ë§Œ ì§€ì›ë©ë‹ˆë‹¤.'
        });
    }

    try {
        const { region = DEFAULT_REGION, lat, lon, nx, ny, detailed = 'true' } = req.query;
        const weatherApiKey = process.env.WEATHER_API_KEY;
        const kakaoApiKey = process.env.KAKAO_REST_API_KEY; // Kakao API í‚¤

        console.log('ì™„ì „í•œ ë‚ ì”¨ API ìš”ì²­:', {
            region, lat, lon, nx, ny, detailed,
            hasWeatherApiKey: !!weatherApiKey,
            hasKakaoApiKey: !!kakaoApiKey, // Kakao API í‚¤ ì¡´ì¬ ì—¬ë¶€ ë¡œê¹…
            timestamp: new Date().toISOString()
        });

        // API í‚¤ í™•ì¸ ë° ìƒ˜í”Œ ë°ì´í„° ì œê³µ ë¡œì§
        if (!weatherApiKey) {
            console.warn('âš ï¸ WEATHER_API_KEY í™˜ê²½ ë³€ìˆ˜ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ìƒ˜í”Œ ë°ì´í„°ë¥¼ ì œê³µí•©ë‹ˆë‹¤.');
            return res.status(200).json({
                success: true,
                data: generateCompleteSampleData(region, 'WEATHER_API_KEY ë¯¸ì„¤ì •'),
                warning: 'WEATHER_API_KEYê°€ ì„¤ì •ë˜ì§€ ì•Šì•„ ìƒ˜í”Œ ë°ì´í„°ë¥¼ ì œê³µí•©ë‹ˆë‹¤.',
                environment: 'development',
                apiInfo: {
                    source: 'ìƒ˜í”Œ ë°ì´í„°',
                    timestamp: new Date().toISOString(),
                    region: region
                },
                locationInfo: {
                    requested: region,
                    matched: 'ìƒ˜í”Œ ë°ì´í„°ìš© ê¸°ë³¸ê°’',
                    fullName: 'ìƒ˜í”Œ ì§€ì—­',
                    source: 'ìƒ˜í”Œ ë°ì´í„°'
                }
            });
        }

        let coordinates;
        let locationInfo;
        let targetLat, targetLon;

        // 1. nx, nyê°€ ì§ì ‘ ì œê³µëœ ê²½ìš° (ìµœìš°ì„ )
        if (nx && ny) {
            const nxValue = parseInt(nx);
            const nyValue = parseInt(ny);

            if (isNaN(nxValue) || isNaN(nyValue)) {
                throw new Error('ì˜ëª»ëœ ê²©ì ì¢Œí‘œ í˜•ì‹ì…ë‹ˆë‹¤.');
            }
            coordinates = { nx: nxValue, ny: nyValue };
            locationInfo = {
                requested: `ê²©ìì¢Œí‘œ (${nx}, ${ny})`,
                matched: `ê²©ìì¢Œí‘œ (${nx}, ${ny})`,
                fullName: `ê²©ì X:${nxValue}, Y:${nyValue}`,
                coordinates: coordinates,
                source: 'ì§ì ‘ ê²©ì ì¢Œí‘œ'
            };
            console.log('ê²©ì ì¢Œí‘œ ì§ì ‘ ì‚¬ìš©:', coordinates);
        } 
        // 2. ìœ„ê²½ë„ê°€ ì§ì ‘ ì œê³µëœ ê²½ìš°
        else if (lat && lon) {
            targetLat = parseFloat(lat);
            targetLon = parseFloat(lon);

            if (isNaN(targetLat) || isNaN(targetLon)) {
                throw new Error('ì˜ëª»ëœ ìœ„ê²½ë„ í˜•ì‹ì…ë‹ˆë‹¤.');
            }
            coordinates = latLonToGrid(targetLat, targetLon);
            locationInfo = {
                requested: `${lat}, ${lon}`,
                matched: `ìœ„ê²½ë„ (${lat}, ${lon})`,
                fullName: `ìœ„ë„ ${lat}, ê²½ë„ ${lon}`,
                coordinates: coordinates,
                latLon: { lat: targetLat, lon: targetLon },
                source: 'ì§ì ‘ ìœ„ê²½ë„'
            };
            console.log('ìœ„ê²½ë„ ë³€í™˜ ì™„ë£Œ:', { lat, lon, grid: coordinates });
        } 
        // 3. ì§€ì—­ëª…ìœ¼ë¡œ ê²€ìƒ‰ (ìƒˆë¡œìš´ findLocationCoordinates ì‚¬ìš©)
        else {
            const locationResult = await findLocationCoordinates(region, kakaoApiKey); // Kakao API í‚¤ ì „ë‹¬
            targetLat = locationResult.lat;
            targetLon = locationResult.lon; // ìˆ˜ì •: latì´ ì•„ë‹ˆë¼ lon í• ë‹¹
            coordinates = latLonToGrid(targetLat, targetLon);
            locationInfo = {
                requested: region,
                matched: locationResult.name,
                fullName: locationResult.name,
                coordinates: coordinates,
                latLon: { lat: locationResult.lat, lon: locationResult.lon }, 
                source: locationResult.source, // ê²€ìƒ‰ ì†ŒìŠ¤ ì¶”ê°€
                address: locationResult.address || '',
                category: locationResult.category || '',
                matchScore: locationResult.matchScore || 0
            };
            console.log('ğŸ¯ ìµœì¢… ê²€ìƒ‰ ê²°ê³¼:', { 
                query: region, 
                result: locationResult.name, 
                source: locationResult.source,
                score: locationResult.matchScore 
            });
        }

        // í•œêµ­ í‘œì¤€ì‹œ(KST) ê¸°ì¤€ ì‹œê°„ ê³„ì‚°
        const now = new Date();
        const kst = new Date(now.getTime() + 9 * 60 * 60 * 1000);

        // ê¸°ìƒì²­ API ë°œí‘œ ì‹œê° ê³„ì‚° (ê°€ì¥ ìµœì‹  ë°œí‘œ ì‹œê°„ ê¸°ì¤€)
        let baseTime = '';
        let baseDate = kst.toISOString().slice(0, 10).replace(/-/g, '');
        const currentHour = kst.getHours();
        const currentMinute = kst.getMinutes();

        // ê¸°ìƒì²­ API ë°œí‘œ ì‹œê°„ (ë§¤ 3ì‹œê°„ ê°„ê²©, 02, 05, 08, 11, 14, 17, 20, 23ì‹œ ì •ê°)
        // ë°œí‘œ í›„ ì•½ 10ë¶„ ì •ë„ ì§€ë‚˜ì•¼ ë°ì´í„°ê°€ ì•ˆì •ì ìœ¼ë¡œ ì˜¬ë¼ì˜´
        const validBaseTimes = [2, 5, 8, 11, 14, 17, 20, 23];
        let foundBaseTime = false;

        for (let i = validBaseTimes.length - 1; i >= 0; i--) {
            const bt = validBaseTimes[i];
            // í˜„ì¬ ì‹œê°„ë³´ë‹¤ ê°™ê±°ë‚˜ ì´ë¥¸ ë°œí‘œ ì‹œê°„ ì¤‘, ì´ë¯¸ ë°œí‘œëœ ì‹œê°„ (ë°œí‘œ ì‹œê° + 10ë¶„ ì´í›„)
            if (currentHour > bt || (currentHour === bt && currentMinute >= 10)) {
                baseTime = String(bt).padStart(2, '0') + '00';
                foundBaseTime = true;
                break;
            }
        }

        // ë§Œì•½ ìƒˆë²½ 2ì‹œ ë°œí‘œ ì‹œê°„ ì´ì „ì´ë¼ë©´, ì „ë‚  23ì‹œ ë°ì´í„°ë¥¼ ì‚¬ìš©
        if (!foundBaseTime) {
            baseTime = '2300';
            const yesterday = new Date(kst.getTime() - 24 * 60 * 60 * 1000);
            baseDate = yesterday.toISOString().slice(0, 10).replace(/-/g, '');
        }

        // ìºì‹œ í‚¤ ìƒì„± ë° í™•ì¸
        const cacheKey = `complete_${coordinates.nx}_${coordinates.ny}_${baseDate}_${baseTime}`;
        const cachedData = weatherCache.get(cacheKey);

        if (cachedData && Date.now() - cachedData.timestamp < 30 * 60 * 1000) { // 30ë¶„ ìºì‹œ ìœ íš¨
            console.log('âœ… ìºì‹œëœ ë°ì´í„° ì‚¬ìš©:', cacheKey);
            const responseData = { ...cachedData.data };
            responseData.locationInfo = locationInfo; // í˜„ì¬ ìš”ì²­ì— ë§ëŠ” locationInfoë¡œ ë®ì–´ì“°ê¸°
            return res.status(200).json(responseData);
        }

        console.log('ğŸŒ¤ï¸ ê¸°ìƒì²­ API í˜¸ì¶œ ì‹œì‘:', {
            baseDate,
            baseTime,
            nx: coordinates.nx,
            ny: coordinates.ny,
            location: locationInfo.fullName
        });

        // ê¸°ìƒì²­ API í˜¸ì¶œ
        const response = await axios.get('http://apis.data.go.kr/1360000/VilageFcstInfoService_2.0/getVilageFcst', {
            params: {
                serviceKey: weatherApiKey,
                numOfRows: 300, // ì¶©ë¶„í•œ ë°ì´í„° ë¡œë“œ
                pageNo: 1,
                dataType: 'JSON',
                base_date: baseDate,
                base_time: baseTime,
                nx: coordinates.nx,
                ny: coordinates.ny
            },
            timeout: 10000, // 10ì´ˆ íƒ€ì„ì•„ì›ƒ
            headers: {
                'User-Agent': 'HealingK-Complete-Weather-Service/2.0'
            }
        });

        // API ì‘ë‹µ ê²€ì¦
        if (!response.data?.response?.body?.items?.item) {
            const resultCode = response.data?.response?.header?.resultCode || 'UNKNOWN';
            const resultMsg = response.data?.response?.header?.resultMsg || 'ì‘ë‹µ ë°ì´í„° ì—†ìŒ';
            throw new Error(`ê¸°ìƒì²­ API ì‘ë‹µì— ë‚ ì”¨ ë°ì´í„°ê°€ ì—†ê±°ë‚˜ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤. (ì½”ë“œ: ${resultCode}, ë©”ì‹œì§€: ${resultMsg})`);
        }

        const resultCode = response.data.response.header.resultCode;
        if (resultCode !== '00') {
            const errorMsg = ERROR_MESSAGES[resultCode] || `ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ (ì½”ë“œ: ${resultCode})`;
            throw new Error(`ê¸°ìƒì²­ API ì˜¤ë¥˜: ${errorMsg}`);
        }

        const items = response.data.response.body.items.item || [];
        console.log('ğŸ“Š ë°›ì€ ê¸°ìƒ ë°ì´í„° í•­ëª© ìˆ˜:', items.length);

        // ì™„ì „í•œ ë‚ ì”¨ ë°ì´í„° ì²˜ë¦¬
        const weatherData = processCompleteWeatherData(items, kst);

        // weatherDataê°€ ë¹„ì–´ìˆì„ ê²½ìš° (ë°ì´í„°ê°€ ì—†ê±°ë‚˜ íŒŒì‹± ì˜¤ë¥˜)
        if (!weatherData || weatherData.length === 0) {
            throw new Error('ê¸°ìƒì²­ API ë°ì´í„° íŒŒì‹± ì‹¤íŒ¨ ë˜ëŠ” ìœ íš¨í•œ ë‚ ì”¨ ì •ë³´ ì—†ìŒ.');
        }

        console.log('âœ… ì™„ì „í•œ ë‚ ì”¨ ë°ì´í„° ì²˜ë¦¬ ì™„ë£Œ:', weatherData.length, 'ì¼');

        // í˜„ì¬ ë‚ ì”¨ ë°ì´í„° ì¶”ì¶œ (ì²« ë²ˆì§¸ ìš”ì†Œê°€ ì˜¤ëŠ˜)
        const currentWeather = weatherData[0];

        // ê°„ë‹¨í•œ ì‘ë‹µ í˜•ì‹ (í”„ë¡ íŠ¸ì—”ë“œ ìš”êµ¬ì‚¬í•­ì— ë§ì¶¤)
        const simpleResponse = {
            success: true,
            temperature: currentWeather.temperature,
            weather: currentWeather.weatherStatus,
            humidity: currentWeather.humidity,
            windSpeed: currentWeather.windSpeed,
            locationInfo: locationInfo,
            timestamp: new Date().toISOString(),
            fullData: detailed === 'true' ? weatherData : undefined // ìƒì„¸ ì •ë³´ë„ í¬í•¨ (í•„ìš”ì‹œ ì‚¬ìš©)
        };

        // ìºì‹œ ì €ì¥
        weatherCache.set(cacheKey, {
            data: simpleResponse,
            timestamp: Date.now()
        });

        // ìºì‹œ í¬ê¸° ê´€ë¦¬ (ìµœëŒ€ 100ê°œ í•­ëª©)
        if (weatherCache.size > 100) {
            const oldestKey = weatherCache.keys().next().value;
            weatherCache.delete(oldestKey);
            console.log('ğŸ§¹ ìºì‹œ ì •ë¦¬ ì™„ë£Œ. í˜„ì¬ ìºì‹œ í¬ê¸°:', weatherCache.size);
        }

        console.log('ğŸ‰ ì™„ì „í•œ ë‚ ì”¨ API ì‘ë‹µ ì„±ê³µ');
        return res.status(200).json(simpleResponse);

    } catch (error) {
        console.error('âŒ ì™„ì „í•œ ë‚ ì”¨ API ì˜¤ë¥˜ ë°œìƒ:', {
            message: error.message,
            code: error.code,
            response: error.response?.data,
            stack: process.env.NODE_ENV === 'development' ? error.stack : undefined
        });

        // ì—ëŸ¬ ë°œìƒ ì‹œ ìƒ˜í”Œ ë°ì´í„° ë°˜í™˜ (ì˜¤ë¥˜ ë©”ì‹œì§€ í¬í•¨)
        return res.status(200).json({
            success: false, // ì‹¤íŒ¨ë¡œ í‘œì‹œ
            error: true,
            errorMessage: error.message,
            data: generateCompleteSampleData(req.query.region || DEFAULT_REGION, error.message), // ìƒ˜í”Œ ë°ì´í„° ë°˜í™˜
            locationInfo: {
                requested: req.query.region || req.query.nx || req.query.lat || DEFAULT_REGION,
                matched: 'ì˜¤ë¥˜ ë°œìƒ',
                fullName: 'ì˜¤ë¥˜ë¡œ ì •ë³´ ì—†ìŒ',
                source: 'ì˜¤ë¥˜ ì²˜ë¦¬ (ìƒ˜í”Œ ë°ì´í„°)'
            },
            timestamp: new Date().toISOString(),
            warning: 'ì‹¤ì‹œê°„ ë‚ ì”¨ ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ëŠ” ë° ì‹¤íŒ¨í•˜ì—¬ ìƒ˜í”Œ ë°ì´í„°ë¥¼ í‘œì‹œí•©ë‹ˆë‹¤.'
        });
    }
};

